<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹›ç”Ÿè®¡åˆ’æ•°æ®æ¯”å¯¹ä¸è½¬æ¢å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            overflow: hidden;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eaeaea;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #3498db, #2c3e50);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .workflow {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            position: relative;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 25px;
            position: relative;
            z-index: 1;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .step.active .step-number {
            background: #27ae60;
            transform: scale(1.1);
            box-shadow: 0 0 0 5px rgba(39, 174, 96, 0.2);
        }
        
        .step.completed .step-number {
            background: #27ae60;
        }
        
        .step-text {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            color: #2c3e50;
        }
        
        .step-arrow {
            font-size: 24px;
            color: #95a5a6;
            margin: 0 10px;
        }
        
        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1200px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
        }
        
        .upload-box {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .upload-box:hover {
            border-color: #3498db;
            background: #f0f7ff;
        }
        
        .upload-box h3 {
            color: #3498db;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
        }
        
        .file-input {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }
        
        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            text-align: left;
            font-size: 13px;
            color: #666;
            min-height: 60px;
        }
        
        .field-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
            border-left: 4px solid #3498db;
        }
        
        .match-fields {
            display: inline-block;
            background: #e3f2fd;
            padding: 3px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 13px;
        }
        
        .match-fields.info {
            background: #d1ecf1;
        }
        
        .control-section {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 140px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #219a52);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .result-section {
            margin-top: 30px;
            display: none;
        }
        
        .result-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eaeaea;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 500;
            color: #7f8c8d;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .tab-btn:hover {
            color: #3498db;
        }
        
        .tab-btn.active {
            color: #3498db;
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #3498db;
            border-radius: 2px 2px 0 0;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            padding: 18px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-top: 4px solid #3498db;
        }
        
        .stat-card.success {
            border-color: #27ae60;
        }
        
        .stat-card.warning {
            border-color: #f39c12;
        }
        
        .stat-card.info {
            border-color: #17a2b8;
        }
        
        .stat-card.danger {
            border-color: #e74c3c;
        }
        
        .stat-card.purple {
            border-color: #9b59b6;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin: 8px 0;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 13px;
        }
        
        .filter-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .filter-row:last-child {
            margin-bottom: 0;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }
        
        .filter-label {
            font-weight: 500;
            color: #495057;
            white-space: nowrap;
            min-width: 60px;
        }
        
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            flex: 1;
            min-width: 120px;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            flex: 1;
            min-width: 120px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .filter-btn:hover {
            background: #2980b9;
        }
        
        .filter-btn.secondary {
            background: #6c757d;
        }
        
        .filter-btn.secondary:hover {
            background: #5a6268;
        }
        
        .filter-btn.apply-all {
            background: #27ae60;
        }
        
        .filter-btn.apply-all:hover {
            background: #219a52;
        }
        
        .current-filter {
            margin-top: 10px;
            padding: 10px;
            background: #e7f3ff;
            border-radius: 6px;
            font-size: 14px;
            color: #0066cc;
            display: none;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 14px 12px;
            text-align: left;
            font-weight: 500;
            font-size: 14px;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .status-exists {
            color: #27ae60;
            font-weight: bold;
        }
        
        .status-not-exists {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .conversion-section {
            margin-top: 40px;
            padding: 25px;
            background: #f0f8ff;
            border-radius: 10px;
            border: 2px solid #e3f2fd;
            display: none;
        }
        
        .conversion-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .conversion-action {
            text-align: center;
            margin-top: 20px;
        }
        
        .instructions {
            background-color: #f0f7ff;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #95a5a6;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
            
            .stats, .conversion-stats {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .control-section {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .workflow {
                flex-direction: column;
                gap: 20px;
            }
            
            .step-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“ æ‹›ç”Ÿè®¡åˆ’æ•°æ®æ¯”å¯¹ä¸è½¬æ¢å·¥å…·</h1>
            <p class="subtitle">ä¸Šä¼ æ‹›ç”Ÿè®¡åˆ’ã€ä¸“ä¸šåˆ†å’Œé™¢æ ¡åˆ†æ–‡ä»¶è¿›è¡Œæ¯”å¯¹ï¼Œå¯¼å‡ºæœªåŒ¹é…æ•°æ®ä¸ºä¸“ä¸šåˆ†æ ¼å¼</p>
        </header>
        
        <div class="workflow">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-text">ä¸Šä¼ æ–‡ä»¶</div>
            </div>
            <div class="step-arrow">â†’</div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-text">æ•°æ®æ¯”å¯¹</div>
            </div>
            <div class="step-arrow">â†’</div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-text">å¯¼å‡ºæœªåŒ¹é…æ•°æ®</div>
            </div>
        </div>
        
        <div class="field-info">
            <div style="margin-bottom: 10px;">
                <strong>æ¯”å¯¹1ï¼ˆæ‹›ç”Ÿè®¡åˆ’ vs ä¸“ä¸šåˆ†ï¼‰ï¼š</strong><br>
                <span style="color: #666; font-size: 13px;">æ£€æŸ¥æ‹›ç”Ÿè®¡åˆ’çš„è®°å½•æ˜¯å¦åœ¨ä¸“ä¸šåˆ†ä¸­å­˜åœ¨</span><br>
                <span class="match-fields">å¹´ä»½</span>
                <span class="match-fields">çœä»½</span>
                <span class="match-fields">å­¦æ ¡</span>
                <span class="match-fields">ç§‘ç±»</span>
                <span class="match-fields">æ‰¹æ¬¡</span>
                <span class="match-fields">ä¸“ä¸š</span>
                <span class="match-fields">å±‚æ¬¡</span>
                <span class="match-fields">ä¸“ä¸šç»„ä»£ç </span>
            </div>
            <div>
                <strong>æ¯”å¯¹2ï¼ˆæ‹›ç”Ÿè®¡åˆ’ vs é™¢æ ¡åˆ†ï¼‰ï¼š</strong><br>
                <span style="color: #666; font-size: 13px;">æ£€æŸ¥æ‹›ç”Ÿè®¡åˆ’çš„è®°å½•æ˜¯å¦åœ¨é™¢æ ¡åˆ†ä¸­å­˜åœ¨</span><br>
                <span class="match-fields info">å¹´ä»½</span>
                <span class="match-fields info">çœä»½</span>
                <span class="match-fields info">å­¦æ ¡</span>
                <span class="match-fields info">ç§‘ç±»</span>
                <span class="match-fields info">æ‰¹æ¬¡</span>
                <span class="match-fields info">ä¸“ä¸šç»„ä»£ç </span>
            </div>
        </div>
        
        <div class="upload-section">
            <div class="upload-box">
                <h3>ğŸ“‹ æ‹›ç”Ÿè®¡åˆ’æ–‡ä»¶</h3>
                <p>åŒ…å«æ‹›ç”Ÿè®¡åˆ’ä¿¡æ¯çš„Excelæ–‡ä»¶</p>
                <input type="file" id="planFile" class="file-input" accept=".xlsx, .xls">
                <div class="file-info" id="planInfo">ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...</div>
            </div>
            
            <div class="upload-box">
                <h3>ğŸ“Š ä¸“ä¸šåˆ†æ–‡ä»¶</h3>
                <p>åŒ…å«ä¸“ä¸šåˆ†ä¿¡æ¯çš„Excelæ–‡ä»¶</p>
                <input type="file" id="scoreFile" class="file-input" accept=".xlsx, .xls">
                <div class="file-info" id="scoreInfo">ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...</div>
            </div>
            
            <div class="upload-box">
                <h3>ğŸ« é™¢æ ¡åˆ†æ–‡ä»¶</h3>
                <p>åŒ…å«é™¢æ ¡åˆ†ä¿¡æ¯çš„Excelæ–‡ä»¶</p>
                <input type="file" id="collegeFile" class="file-input" accept=".xlsx, .xls">
                <div class="file-info" id="collegeInfo">ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...</div>
            </div>
        </div>
        
        <div class="instructions">
            <strong>ğŸ“ è¯´æ˜ï¼š</strong> ä¸Šä¼ æ‹›ç”Ÿè®¡åˆ’ã€ä¸“ä¸šåˆ†å’Œé™¢æ ¡åˆ†ä¸‰ä¸ªExcelæ–‡ä»¶ï¼Œå…ˆè¿›è¡Œæ•°æ®æ¯”å¯¹ï¼Œç„¶åå¯ä»¥å°†æœªåŒ¹é…çš„æ‹›ç”Ÿè®¡åˆ’æ•°æ®è½¬æ¢ä¸ºä¸“ä¸šåˆ†æ ¼å¼å¯¼å‡ºã€‚
        </div>
        
        <div class="control-section">
            <button class="btn" onclick="comparePlanVsScore()">æ¯”å¯¹1ï¼šæ‹›ç”Ÿè®¡åˆ’ vs ä¸“ä¸šåˆ†</button>
            <button class="btn btn-info" onclick="comparePlanVsCollege()">æ¯”å¯¹2ï¼šæ‹›ç”Ÿè®¡åˆ’ vs é™¢æ ¡åˆ†</button>
            <button class="btn btn-success" onclick="compareAll()" id="allCompareBtn">å…¨éƒ¨æ¯”å¯¹</button>
            <button class="btn btn-purple" onclick="exportAllResults()" id="exportAllBtn" style="display:none;">ğŸ“Š å¯¼å‡ºå…¨éƒ¨ç»“æœ</button>
            <button class="btn btn-secondary" onclick="resetAll()">é‡ç½®</button>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">æ­£åœ¨å¤„ç†æ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>
        
        <div class="result-section" id="resultSection">
            <div class="result-tabs">
                <button class="tab-btn active" onclick="switchTab('planScoreTab')">æ¯”å¯¹1ï¼šæ‹›ç”Ÿè®¡åˆ’ vs ä¸“ä¸šåˆ†</button>
                <button class="tab-btn" onclick="switchTab('planCollegeTab')">æ¯”å¯¹2ï¼šæ‹›ç”Ÿè®¡åˆ’ vs é™¢æ ¡åˆ†</button>
            </div>
            
            <!-- æ¯”å¯¹1ç»“æœ -->
            <div id="planScoreTab" class="tab-content active">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">æ‹›ç”Ÿè®¡åˆ’æ€»è®°å½•æ•°</div>
                        <div class="stat-value" id="planScoreTotal">0</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">åŒ¹é…è®°å½•æ•°</div>
                        <div class="stat-value" id="planScoreMatched">0</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-label">æœªåŒ¹é…è®°å½•æ•°</div>
                        <div class="stat-value" id="planScoreUnmatched">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">åŒ¹é…ç‡</div>
                        <div class="stat-value" id="planScoreRate">0%</div>
                    </div>
                </div>
                
                <!-- æ¯”å¯¹1ç­›é€‰æ§ä»¶ -->
                <div class="filter-controls" id="planScoreFilters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <span class="filter-label">çœä»½:</span>
                            <input type="text" class="filter-input" id="planScoreProvinceFilter" list="planScoreProvinceList" placeholder="è¾“å…¥æˆ–é€‰æ‹©çœä»½">
                            <datalist id="planScoreProvinceList">
                                <option value="å…¨éƒ¨çœä»½">
                            </datalist>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">æ‰¹æ¬¡:</span>
                            <input type="text" class="filter-input" id="planScoreBatchFilter" list="planScoreBatchList" placeholder="è¾“å…¥æˆ–é€‰æ‹©æ‰¹æ¬¡">
                            <datalist id="planScoreBatchList">
                                <option value="å…¨éƒ¨æ‰¹æ¬¡">
                            </datalist>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">åŒ¹é…çŠ¶æ€:</span>
                            <select class="filter-select" id="planScoreMatchStatusFilter">
                                <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="matched">åŒ¹é…</option>
                                <option value="unmatched">æœªåŒ¹é…</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <span class="filter-label">æ˜¾ç¤ºé€‰é¡¹:</span>
                            <select class="filter-select" id="planScoreDisplayOption">
                                <option value="all">æ˜¾ç¤ºå…¨éƒ¨è®°å½•</option>
                                <option value="100">ä»…æ˜¾ç¤ºå‰100æ¡</option>
                                <option value="500">ä»…æ˜¾ç¤ºå‰500æ¡</option>
                            </select>
                        </div>
                        <div class="filter-group" style="justify-content: flex-end; gap: 10px;">
                            <button class="filter-btn apply-all" onclick="applyPlanScoreFilter()">åº”ç”¨ç­›é€‰</button>
                            <button class="filter-btn secondary" onclick="resetPlanScoreFilter()">é‡ç½®ç­›é€‰</button>
                        </div>
                    </div>
                </div>
                
                <div id="planScoreCurrentFilter" class="current-filter"></div>
                
                <div id="planScoreResultsTable"></div>
                <div style="text-align:center; margin-top:20px;">
                    <button class="btn btn-success" onclick="exportPlanScoreResults()" id="exportPlanScoreBtn" style="display:none;">å¯¼å‡ºæ¯”å¯¹1ç»“æœ</button>
                    <button class="btn btn-warning" onclick="exportUnmatchedPlanScoreAsScore()" id="exportUnmatchedPlanScoreBtn" style="display:none;">å¯¼å‡ºæœªåŒ¹é…æ•°æ®ä¸ºä¸“ä¸šåˆ†æ ¼å¼</button>
                </div>
            </div>
            
            <!-- æ¯”å¯¹2ç»“æœ -->
            <div id="planCollegeTab" class="tab-content">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">æ‹›ç”Ÿè®¡åˆ’æ€»è®°å½•æ•°</div>
                        <div class="stat-value" id="planCollegeTotal">0</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">åŒ¹é…è®°å½•æ•°</div>
                        <div class="stat-value" id="planCollegeMatched">0</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-label">æœªåŒ¹é…è®°å½•æ•°</div>
                        <div class="stat-value" id="planCollegeUnmatched">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">åŒ¹é…ç‡</div>
                        <div class="stat-value" id="planCollegeRate">0%</div>
                    </div>
                </div>
                
                <!-- æ¯”å¯¹2ç­›é€‰æ§ä»¶ -->
                <div class="filter-controls" id="planCollegeFilters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <span class="filter-label">çœä»½:</span>
                            <input type="text" class="filter-input" id="planCollegeProvinceFilter" list="planCollegeProvinceList" placeholder="è¾“å…¥æˆ–é€‰æ‹©çœä»½">
                            <datalist id="planCollegeProvinceList">
                                <option value="å…¨éƒ¨çœä»½">
                            </datalist>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">æ‰¹æ¬¡:</span>
                            <input type="text" class="filter-input" id="planCollegeBatchFilter" list="planCollegeBatchList" placeholder="è¾“å…¥æˆ–é€‰æ‹©æ‰¹æ¬¡">
                            <datalist id="planCollegeBatchList">
                                <option value="å…¨éƒ¨æ‰¹æ¬¡">
                            </datalist>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">åŒ¹é…çŠ¶æ€:</span>
                            <select class="filter-select" id="planCollegeMatchStatusFilter">
                                <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="matched">åŒ¹é…</option>
                                <option value="unmatched">æœªåŒ¹é…</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <span class="filter-label">æ˜¾ç¤ºé€‰é¡¹:</span>
                            <select class="filter-select" id="planCollegeDisplayOption">
                                <option value="all">æ˜¾ç¤ºå…¨éƒ¨è®°å½•</option>
                                <option value="100">ä»…æ˜¾ç¤ºå‰100æ¡</option>
                                <option value="500">ä»…æ˜¾ç¤ºå‰500æ¡</option>
                            </select>
                        </div>
                        <div class="filter-group" style="justify-content: flex-end; gap: 10px;">
                            <button class="filter-btn apply-all" onclick="applyPlanCollegeFilter()">åº”ç”¨ç­›é€‰</button>
                            <button class="filter-btn secondary" onclick="resetPlanCollegeFilter()">é‡ç½®ç­›é€‰</button>
                        </div>
                    </div>
                </div>
                
                <div id="planCollegeCurrentFilter" class="current-filter"></div>
                
                <div id="planCollegeResultsTable"></div>
                <div style="text-align:center; margin-top:20px;">
                    <button class="btn btn-success" onclick="exportPlanCollegeResults()" id="exportPlanCollegeBtn" style="display:none;">å¯¼å‡ºæ¯”å¯¹2ç»“æœ</button>
                    <button class="btn btn-warning" onclick="exportUnmatchedPlanCollegeAsScore()" id="exportUnmatchedPlanCollegeBtn" style="display:none;">å¯¼å‡ºæœªåŒ¹é…æ•°æ®ä¸ºä¸“ä¸šåˆ†æ ¼å¼</button>
                </div>
            </div>
        </div>
        
        <div class="conversion-section" id="conversionSection">
            <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">ğŸ¯ æœªåŒ¹é…æ•°æ®è½¬æ¢</h3>
            
            <div class="conversion-stats">
                <div class="stat-card">
                    <div class="stat-label">å¾…è½¬æ¢è®°å½•æ•°</div>
                    <div class="stat-value" id="conversionTotal">0</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-label">è½¬æ¢ç±»å‹</div>
                    <div class="stat-value" id="conversionType">-</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-label">å¹´ä»½</div>
                    <div class="stat-value" id="conversionYear">-</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-label">çœä»½æ•°é‡</div>
                    <div class="stat-value" id="conversionProvinceCount">0</div>
                </div>
            </div>
            
            <div class="instructions">
                <strong>è½¬æ¢è¯´æ˜ï¼š</strong> å°†æœªåŒ¹é…çš„æ‹›ç”Ÿè®¡åˆ’æ•°æ®è½¬æ¢ä¸ºä¸“ä¸šåˆ†å¯¼å…¥æ¨¡æ¿æ ¼å¼ï¼ŒåŒ…æ‹¬å­—æ®µæ˜ å°„ã€é€‰ç§‘è¦æ±‚è½¬æ¢ã€ä»£ç æ ¼å¼å¤„ç†ç­‰ã€‚
                <br><strong>ç‰¹åˆ«å¤„ç†ï¼š</strong> å½“"ä¸“ä¸šç»„é€‰ç§‘è¦æ±‚"åŒ…å«"å¿…é€‰"æ—¶ï¼Œè½¬æ¢ä¸º"å•ç§‘ã€å¤šç§‘å‡éœ€é€‰è€ƒ"ï¼Œæ¬¡é€‰ç§‘ç›®å¡«å…¥å¿…é€‰ç§‘ç›®çš„ç¬¬ä¸€ä¸ªå­—ã€‚
            </div>
            
            <div class="conversion-action">
                <button class="btn btn-success" onclick="convertAndExportUnmatchedData()" id="convertAndExportBtn">
                    ğŸ”„ è½¬æ¢å¹¶å¯¼å‡ºä¸ºä¸“ä¸šåˆ†æ ¼å¼
                </button>
                <button class="btn btn-secondary" onclick="previewConversion()" id="previewBtn">
                    ğŸ‘ï¸ é¢„è§ˆè½¬æ¢ç»“æœ
                </button>
            </div>
            
            <div id="conversionPreview" style="display: none; margin-top: 20px;"></div>
        </div>
        
        <footer>
            <p>Â© 2024 æ‹›ç”Ÿè®¡åˆ’æ•°æ®æ¯”å¯¹ä¸è½¬æ¢å·¥å…· | åŸºäº SheetJS (xlsx.js) æ„å»º | æ‰€æœ‰æ•°æ®å¤„ç†å‡åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆ</p>
        </footer>
    </div>

    <!-- SheetJSåº“ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <!-- FileSaver.jsåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let planData = [];
        let scoreData = [];
        let collegeData = [];
        let planScoreResults = [];
        let planCollegeResults = [];
        let isComparing = false;
        let conversionData = []; // å¾…è½¬æ¢çš„æœªåŒ¹é…æ•°æ®
        let convertedData = []; // è½¬æ¢åçš„æ•°æ®
        let conversionSource = ''; // è½¬æ¢æ¥æºï¼šplanScoreæˆ–planCollege
        
        // ç­›é€‰çŠ¶æ€å˜é‡
        let planScoreFilterState = {
            province: 'all',
            batch: 'all',
            matchStatus: 'all',
            displayOption: 'all'
        };
        
        let planCollegeFilterState = {
            province: 'all',
            batch: 'all',
            matchStatus: 'all',
            displayOption: 'all'
        };
        
        // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç›‘å¬
        document.getElementById('planFile').addEventListener('change', function(e) {
            resetComparisonResults();
            loadFile(e.target.files[0], 'plan');
        });
        
        document.getElementById('scoreFile').addEventListener('change', function(e) {
            resetComparisonResults();
            loadFile(e.target.files[0], 'score');
        });
        
        document.getElementById('collegeFile').addEventListener('change', function(e) {
            resetComparisonResults();
            loadFile(e.target.files[0], 'college');
        });
        
        // é‡ç½®æ¯”å¯¹ç»“æœå’ŒçŠ¶æ€
        function resetComparisonResults() {
            planScoreResults = [];
            planCollegeResults = [];
            conversionData = [];
            convertedData = [];
            conversionSource = '';
            
            planScoreFilterState = {
                province: 'all',
                batch: 'all',
                matchStatus: 'all',
                displayOption: 'all'
            };
            
            planCollegeFilterState = {
                province: 'all',
                batch: 'all',
                matchStatus: 'all',
                displayOption: 'all'
            };
            
            // é‡ç½®ç­›é€‰æ§ä»¶
            document.getElementById('planScoreProvinceFilter').value = '';
            document.getElementById('planScoreBatchFilter').value = '';
            document.getElementById('planScoreMatchStatusFilter').value = 'all';
            document.getElementById('planScoreDisplayOption').value = 'all';
            
            document.getElementById('planCollegeProvinceFilter').value = '';
            document.getElementById('planCollegeBatchFilter').value = '';
            document.getElementById('planCollegeMatchStatusFilter').value = 'all';
            document.getElementById('planCollegeDisplayOption').value = 'all';
            
            // æ¸…ç©ºæ•°æ®åˆ—è¡¨
            document.getElementById('planScoreProvinceList').innerHTML = '<option value="å…¨éƒ¨çœä»½">';
            document.getElementById('planScoreBatchList').innerHTML = '<option value="å…¨éƒ¨æ‰¹æ¬¡">';
            document.getElementById('planCollegeProvinceList').innerHTML = '<option value="å…¨éƒ¨çœä»½">';
            document.getElementById('planCollegeBatchList').innerHTML = '<option value="å…¨éƒ¨æ‰¹æ¬¡">';
            
            // æ¸…ç©ºç»“æœè¡¨æ ¼
            document.getElementById('planScoreResultsTable').innerHTML = '';
            document.getElementById('planCollegeResultsTable').innerHTML = '';
            
            // éšè—å½“å‰ç­›é€‰æ˜¾ç¤º
            document.getElementById('planScoreCurrentFilter').style.display = 'none';
            document.getElementById('planCollegeCurrentFilter').style.display = 'none';
            
            // é‡ç½®ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('planScoreTotal').textContent = '0';
            document.getElementById('planScoreMatched').textContent = '0';
            document.getElementById('planScoreUnmatched').textContent = '0';
            document.getElementById('planScoreRate').textContent = '0%';
            
            document.getElementById('planCollegeTotal').textContent = '0';
            document.getElementById('planCollegeMatched').textContent = '0';
            document.getElementById('planCollegeUnmatched').textContent = '0';
            document.getElementById('planCollegeRate').textContent = '0%';
            
            // éšè—å¯¼å‡ºæŒ‰é’®
            document.getElementById('exportPlanScoreBtn').style.display = 'none';
            document.getElementById('exportPlanCollegeBtn').style.display = 'none';
            document.getElementById('exportAllBtn').style.display = 'none';
            document.getElementById('exportUnmatchedPlanScoreBtn').style.display = 'none';
            document.getElementById('exportUnmatchedPlanCollegeBtn').style.display = 'none';
            
            // éšè—è½¬æ¢åŒºåŸŸ
            document.getElementById('conversionSection').style.display = 'none';
            document.getElementById('conversionPreview').style.display = 'none';
            
            // é‡ç½®æ­¥éª¤
            updateWorkflowStep(1);
            
            isComparing = false;
        }
        
        // æ›´æ–°å·¥ä½œæµæ­¥éª¤
        function updateWorkflowStep(step) {
            // é‡ç½®æ‰€æœ‰æ­¥éª¤
            document.getElementById('step1').classList.remove('completed', 'active');
            document.getElementById('step2').classList.remove('completed', 'active');
            document.getElementById('step3').classList.remove('completed', 'active');
            
            // è®¾ç½®å½“å‰æ­¥éª¤
            if (step >= 1) {
                document.getElementById('step1').classList.add('completed');
                if (step === 1) document.getElementById('step1').classList.add('active');
            }
            if (step >= 2) {
                document.getElementById('step2').classList.add('completed');
                if (step === 2) document.getElementById('step2').classList.add('active');
            }
            if (step >= 3) {
                document.getElementById('step3').classList.add('completed');
                if (step === 3) document.getElementById('step3').classList.add('active');
            }
        }
        
        // åŠ è½½Excelæ–‡ä»¶
        function loadFile(file, type) {
            if (!file) return;
            
            const infoDiv = document.getElementById(type + 'Info');
            infoDiv.innerHTML = `<span style="color:#3498db">æ­£åœ¨è¯»å–æ–‡ä»¶...</span>`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    
                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // è½¬æ¢ä¸ºJSON
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                    
                    if (type === 'plan') {
                        planData = jsonData;
                    } else if (type === 'score') {
                        scoreData = jsonData;
                    } else if (type === 'college') {
                        collegeData = jsonData;
                    }
                    
                    infoDiv.innerHTML = `
                        <strong>âœ“ æ–‡ä»¶åŠ è½½æˆåŠŸ</strong><br>
                        æ–‡ä»¶å: ${file.name}<br>
                        è®°å½•æ•°: ${jsonData.length} æ¡<br>
                        åŠ è½½æ—¶é—´: ${new Date().toLocaleTimeString()}
                    `;
                    
                    console.log(`${type}æ•°æ®åŠ è½½æˆåŠŸ:`, jsonData.length, 'æ¡è®°å½•');
                    
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¯ç”¨"å…¨éƒ¨æ¯”å¯¹"æŒ‰é’®
                    checkAllFilesLoaded();
                    
                } catch (error) {
                    infoDiv.innerHTML = `<span style="color:#e74c3c">âŒ æ–‡ä»¶è¯»å–å¤±è´¥: ${error.message}</span>`;
                    console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', error);
                }
            };
            
            reader.onerror = function() {
                infoDiv.innerHTML = `<span style="color:#e74c3c">âŒ æ–‡ä»¶è¯»å–å¤±è´¥</span>`;
            };
            
            reader.readAsBinaryString(file);
        }
        
        // æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶æ˜¯å¦å·²åŠ è½½
        function checkAllFilesLoaded() {
            const allCompareBtn = document.getElementById('allCompareBtn');
            const fileCount = (planData.length > 0 ? 1 : 0) + 
                             (scoreData.length > 0 ? 1 : 0) + 
                             (collegeData.length > 0 ? 1 : 0);
            if (fileCount >= 2) {
                allCompareBtn.disabled = false;
                allCompareBtn.style.opacity = '1';
            } else {
                allCompareBtn.disabled = true;
                allCompareBtn.style.opacity = '0.5';
            }
        }
        
        // ç”Ÿæˆæ‹›ç”Ÿè®¡åˆ’ vs ä¸“ä¸šåˆ†çš„ç»„åˆé”®ï¼ˆå¢åŠ ä¸“ä¸šç»„ä»£ç ï¼‰
        function generatePlanScoreKey(item) {
            const year = String(item['å¹´ä»½'] || '').trim();
            const province = String(item['çœä»½'] || '').trim();
            const school = String(item['å­¦æ ¡'] || '').trim();
            const subject = String(item['ç§‘ç±»'] || '').trim();
            const batch = String(item['æ‰¹æ¬¡'] || '').trim();
            const major = String(item['ä¸“ä¸š'] || '').trim();
            const level = String(item['å±‚æ¬¡'] || '').trim();
            const groupCode = String(item['ä¸“ä¸šç»„ä»£ç '] || '').trim();
            
            return `${year}|${province}|${school}|${subject}|${batch}|${major}|${level}|${groupCode}`;
        }
        
        // ç”Ÿæˆæ‹›ç”Ÿè®¡åˆ’ vs é™¢æ ¡åˆ†çš„ç»„åˆé”®ï¼ˆå¢åŠ ä¸“ä¸šç»„ä»£ç ï¼‰
        function generatePlanCollegeKey(item) {
            const year = String(item['å¹´ä»½'] || '').trim();
            const province = String(item['çœä»½'] || '').trim();
            const school = String(item['å­¦æ ¡'] || '').trim();
            const subject = String(item['ç§‘ç±»'] || '').trim();
            const batch = String(item['æ‰¹æ¬¡'] || '').trim();
            const groupCode = String(item['ä¸“ä¸šç»„ä»£ç '] || '').trim();
            
            return `${year}|${province}|${school}|${subject}|${batch}|${groupCode}`;
        }
        
        // æ¯”å¯¹1ï¼šæ‹›ç”Ÿè®¡åˆ’ vs ä¸“ä¸šåˆ†
        function comparePlanVsScore() {
            if (isComparing) {
                alert('æ­£åœ¨è¿›è¡Œæ¯”å¯¹ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            if (planData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æ‹›ç”Ÿè®¡åˆ’æ–‡ä»¶');
                return;
            }
            
            if (scoreData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ ä¸“ä¸šåˆ†æ–‡ä»¶');
                return;
            }
            
            isComparing = true;
            startLoading('æ­£åœ¨æ¯”å¯¹æ‹›ç”Ÿè®¡åˆ’ä¸ä¸“ä¸šåˆ†æ•°æ®...');
            
            setTimeout(() => {
                try {
                    planScoreResults = [];
                    const scoreKeySet = new Set();
                    
                    // ä¸ºä¸“ä¸šåˆ†æ•°æ®å»ºç«‹ç´¢å¼•
                    scoreData.forEach(item => {
                        const key = generatePlanScoreKey(item);
                        scoreKeySet.add(key);
                    });
                    
                    console.log('ä¸“ä¸šåˆ†é”®æ•°é‡:', scoreKeySet.size);
                    
                    // æ¯”å¯¹æ‹›ç”Ÿè®¡åˆ’æ•°æ®
                    planData.forEach((item, index) => {
                        const key = generatePlanScoreKey(item);
                        const exists = scoreKeySet.has(key);
                        
                        planScoreResults.push({
                            index: index + 1,
                            originalIndex: index, // ä¿å­˜åŸå§‹ç´¢å¼•
                            keyFields: {
                                å¹´ä»½: item['å¹´ä»½'] || '',
                                çœä»½: item['çœä»½'] || '',
                                å­¦æ ¡: item['å­¦æ ¡'] || '',
                                ç§‘ç±»: item['ç§‘ç±»'] || '',
                                æ‰¹æ¬¡: item['æ‰¹æ¬¡'] || '',
                                ä¸“ä¸š: item['ä¸“ä¸š'] || '',
                                å±‚æ¬¡: item['å±‚æ¬¡'] || '',
                                ä¸“ä¸šç»„ä»£ç : item['ä¸“ä¸šç»„ä»£ç '] || ''
                            },
                            exists: exists,
                            otherInfo: {
                                æ‹›ç”Ÿäººæ•°: item['æ‹›ç”Ÿäººæ•°'] || '',
                                å­¦è´¹: item['å­¦è´¹'] || '',
                                å­¦åˆ¶: item['å­¦åˆ¶'] || '',
                                ä¸“ä¸šä»£ç : item['ä¸“ä¸šä»£ç '] || '',
                                æ‹›ç”Ÿä»£ç : item['æ‹›ç”Ÿä»£ç '] || '',
                                æ•°æ®æ¥æº: item['æ•°æ®æ¥æº'] || '',
                                å¤‡æ³¨: item['å¤‡æ³¨'] || '',
                                æ‹›ç”Ÿç±»å‹: item['æ‹›ç”Ÿç±»å‹'] || '',
                                ä¸“ä¸šç»„é€‰ç§‘è¦æ±‚: item['ä¸“ä¸šç»„é€‰ç§‘è¦æ±‚'] || '',
                                ä¸“ä¸šé€‰ç§‘è¦æ±‚: item['ä¸“ä¸šé€‰ç§‘è¦æ±‚(æ–°é«˜è€ƒä¸“ä¸šçœä»½)'] || ''
                            }
                        });
                    });
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updatePlanScoreStats();
                    
                    // åˆå§‹åŒ–ç­›é€‰ä¸‹æ‹‰æ¡†
                    initPlanScoreFilters();
                    
                    // æ˜¾ç¤ºç»“æœè¡¨æ ¼
                    displayPlanScoreResults();
                    
                    // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®
                    document.getElementById('exportPlanScoreBtn').style.display = 'inline-block';
                    document.getElementById('exportUnmatchedPlanScoreBtn').style.display = 'inline-block';
                    
                    // æ˜¾ç¤ºå¯¼å‡ºå…¨éƒ¨ç»“æœæŒ‰é’®
                    checkExportAllButton();
                    
                    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                    showResultSection();
                    
                    // åˆ‡æ¢åˆ°æ¯”å¯¹1æ ‡ç­¾é¡µ
                    switchTab('planScoreTab');
                    
                    // æ›´æ–°å·¥ä½œæµæ­¥éª¤
                    updateWorkflowStep(2);
                    
                    stopLoading();
                    isComparing = false;
                    
                    // æ˜¾ç¤ºè½¬æ¢åŒºåŸŸ
                    prepareConversion('planScore');
                    
                    alert(`æ¯”å¯¹1å®Œæˆï¼\næ€»è®°å½•æ•°: ${planData.length}\nåŒ¹é…æ•°: ${planScoreResults.filter(r => r.exists).length}\næœªåŒ¹é…æ•°: ${planScoreResults.filter(r => !r.exists).length}`);
                    
                } catch (error) {
                    stopLoading();
                    isComparing = false;
                    alert('æ¯”å¯¹è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
                    console.error('æ¯”å¯¹é”™è¯¯:', error);
                }
            }, 100);
        }
        
        // æ¯”å¯¹2ï¼šæ‹›ç”Ÿè®¡åˆ’ vs é™¢æ ¡åˆ†
        function comparePlanVsCollege() {
            if (isComparing) {
                alert('æ­£åœ¨è¿›è¡Œæ¯”å¯¹ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            if (planData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æ‹›ç”Ÿè®¡åˆ’æ–‡ä»¶');
                return;
            }
            
            if (collegeData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ é™¢æ ¡åˆ†æ–‡ä»¶');
                return;
            }
            
            isComparing = true;
            startLoading('æ­£åœ¨æ¯”å¯¹æ‹›ç”Ÿè®¡åˆ’ä¸é™¢æ ¡åˆ†æ•°æ®...');
            
            setTimeout(() => {
                try {
                    planCollegeResults = [];
                    const collegeKeySet = new Set();
                    
                    // ä¸ºé™¢æ ¡åˆ†æ•°æ®å»ºç«‹ç´¢å¼•
                    collegeData.forEach(item => {
                        const key = generatePlanCollegeKey(item);
                        collegeKeySet.add(key);
                    });
                    
                    console.log('é™¢æ ¡åˆ†é”®æ•°é‡:', collegeKeySet.size);
                    
                    // æ¯”æ‹›ç”Ÿè®¡åˆ’æ•°æ®
                    planData.forEach((item, index) => {
                        const key = generatePlanCollegeKey(item);
                        const exists = collegeKeySet.has(key);
                        
                        planCollegeResults.push({
                            index: index + 1,
                            originalIndex: index, // ä¿å­˜åŸå§‹ç´¢å¼•
                            keyFields: {
                                å¹´ä»½: item['å¹´ä»½'] || '',
                                çœä»½: item['çœä»½'] || '',
                                å­¦æ ¡: item['å­¦æ ¡'] || '',
                                ç§‘ç±»: item['ç§‘ç±»'] || '',
                                æ‰¹æ¬¡: item['æ‰¹æ¬¡'] || '',
                                ä¸“ä¸šç»„ä»£ç : item['ä¸“ä¸šç»„ä»£ç '] || ''
                            },
                            exists: exists,
                            otherInfo: {
                                ä¸“ä¸š: item['ä¸“ä¸š'] || '',
                                å±‚æ¬¡: item['å±‚æ¬¡'] || '',
                                æ‹›ç”Ÿäººæ•°: item['æ‹›ç”Ÿäººæ•°'] || '',
                                å­¦è´¹: item['å­¦è´¹'] || '',
                                å­¦åˆ¶: item['å­¦åˆ¶'] || '',
                                ä¸“ä¸šä»£ç : item['ä¸“ä¸šä»£ç '] || '',
                                æ‹›ç”Ÿä»£ç : item['æ‹›ç”Ÿä»£ç '] || '',
                                æ•°æ®æ¥æº: item['æ•°æ®æ¥æº'] || '',
                                å¤‡æ³¨: item['å¤‡æ³¨'] || '',
                                æ‹›ç”Ÿç±»å‹: item['æ‹›ç”Ÿç±»å‹'] || '',
                                ä¸“ä¸šç»„é€‰ç§‘è¦æ±‚: item['ä¸“ä¸šç»„é€‰ç§‘è¦æ±‚'] || '',
                                ä¸“ä¸šé€‰ç§‘è¦æ±‚: item['ä¸“ä¸šé€‰ç§‘è¦æ±‚(æ–°é«˜è€ƒä¸“ä¸šçœä»½)'] || ''
                            }
                        });
                    });
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updatePlanCollegeStats();
                    
                    // åˆå§‹åŒ–ç­›é€‰ä¸‹æ‹‰æ¡†
                    initPlanCollegeFilters();
                    
                    // æ˜¾ç¤ºç»“æœè¡¨æ ¼
                    displayPlanCollegeResults();
                    
                    // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®
                    document.getElementById('exportPlanCollegeBtn').style.display = 'inline-block';
                    document.getElementById('exportUnmatchedPlanCollegeBtn').style.display = 'inline-block';
                    
                    // æ˜¾ç¤ºå¯¼å‡ºå…¨éƒ¨ç»“æœæŒ‰é’®
                    checkExportAllButton();
                    
                    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                    showResultSection();
                    
                    // åˆ‡æ¢åˆ°æ¯”å¯¹2æ ‡ç­¾é¡µ
                    switchTab('planCollegeTab');
                    
                    // æ›´æ–°å·¥ä½œæµæ­¥éª¤
                    updateWorkflowStep(2);
                    
                    stopLoading();
                    isComparing = false;
                    
                    // æ˜¾ç¤ºè½¬æ¢åŒºåŸŸ
                    prepareConversion('planCollege');
                    
                    alert(`æ¯”å¯¹2å®Œæˆï¼\næ€»è®°å½•æ•°: ${planData.length}\nåŒ¹é…æ•°: ${planCollegeResults.filter(r => r.exists).length}\næœªåŒ¹é…æ•°: ${planCollegeResults.filter(r => !r.exists).length}`);
                    
                } catch (error) {
                    stopLoading();
                    isComparing = false;
                    alert('æ¯”å¯¹è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
                    console.error('æ¯”å¯¹é”™è¯¯:', error);
                }
            }, 100);
        }
        
        // å…¨éƒ¨æ¯”å¯¹
        function compareAll() {
            if (isComparing) {
                alert('æ­£åœ¨è¿›è¡Œæ¯”å¯¹ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            let comparisonsToRun = [];
            
            if (planData.length > 0 && scoreData.length > 0) {
                comparisonsToRun.push('planVsScore');
            }
            
            if (planData.length > 0 && collegeData.length > 0) {
                comparisonsToRun.push('planVsCollege');
            }
            
            if (comparisonsToRun.length === 0) {
                alert('è¯·è‡³å°‘ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶ä»¥è¿›è¡Œæ¯”å¯¹');
                return;
            }
            
            isComparing = true;
            startLoading('æ­£åœ¨æ‰§è¡Œå…¨éƒ¨æ¯”å¯¹ï¼Œè¯·ç¨å€™...');
            
            let completedComparisons = 0;
            const totalComparisons = comparisonsToRun.length;
            
            function onComparisonComplete() {
                completedComparisons++;
                console.log(`å®Œæˆ ${completedComparisons}/${totalComparisons} ä¸ªæ¯”å¯¹`);
                
                if (completedComparisons >= totalComparisons) {
                    setTimeout(() => {
                        stopLoading();
                        isComparing = false;
                        alert('å…¨éƒ¨æ¯”å¯¹å®Œæˆï¼');
                        
                        // æ˜¾ç¤ºå¯¼å‡ºå…¨éƒ¨ç»“æœæŒ‰é’®
                        checkExportAllButton();
                        
                        // æ›´æ–°å·¥ä½œæµæ­¥éª¤
                        updateWorkflowStep(2);
                        
                        // æ˜¾ç¤ºè½¬æ¢åŒºåŸŸï¼ˆé»˜è®¤ä½¿ç”¨æ¯”å¯¹1çš„ç»“æœï¼‰
                        if (planScoreResults.length > 0) {
                            prepareConversion('planScore');
                        } else if (planCollegeResults.length > 0) {
                            prepareConversion('planCollege');
                        }
                    }, 500);
                }
            }
            
            comparisonsToRun.forEach((comparison, index) => {
                setTimeout(() => {
                    try {
                        switch(comparison) {
                            case 'planVsScore':
                                // æ‰§è¡Œæ¯”å¯¹1
                                planScoreResults = [];
                                const scoreKeySet = new Set();
                                
                                scoreData.forEach(item => {
                                    const key = generatePlanScoreKey(item);
                                    scoreKeySet.add(key);
                                });
                                
                                planData.forEach((item, index) => {
                                    const key = generatePlanScoreKey(item);
                                    const exists = scoreKeySet.has(key);
                                    
                                    planScoreResults.push({
                                        index: index + 1,
                                        originalIndex: index,
                                        keyFields: {
                                            å¹´ä»½: item['å¹´ä»½'] || '',
                                            çœä»½: item['çœä»½'] || '',
                                            å­¦æ ¡: item['å­¦æ ¡'] || '',
                                            ç§‘ç±»: item['ç§‘ç±»'] || '',
                                            æ‰¹æ¬¡: item['æ‰¹æ¬¡'] || '',
                                            ä¸“ä¸š: item['ä¸“ä¸š'] || '',
                                            å±‚æ¬¡: item['å±‚æ¬¡'] || '',
                                            ä¸“ä¸šç»„ä»£ç : item['ä¸“ä¸šç»„ä»£ç '] || ''
                                        },
                                        exists: exists,
                                        otherInfo: {
                                            æ‹›ç”Ÿäººæ•°: item['æ‹›ç”Ÿäººæ•°'] || '',
                                            å­¦è´¹: item['å­¦è´¹'] || '',
                                            å­¦åˆ¶: item['å­¦åˆ¶'] || '',
                                            ä¸“ä¸šä»£ç : item['ä¸“ä¸šä»£ç '] || '',
                                            æ‹›ç”Ÿä»£ç : item['æ‹›ç”Ÿä»£ç '] || '',
                                            æ•°æ®æ¥æº: item['æ•°æ®æ¥æº'] || '',
                                            å¤‡æ³¨: item['å¤‡æ³¨'] || '',
                                            æ‹›ç”Ÿç±»å‹: item['æ‹›ç”Ÿç±»å‹'] || '',
                                            ä¸“ä¸šç»„é€‰ç§‘è¦æ±‚: item['ä¸“ä¸šç»„é€‰ç§‘è¦æ±‚'] || '',
                                            ä¸“ä¸šé€‰ç§‘è¦æ±‚: item['ä¸“ä¸šé€‰ç§‘è¦æ±‚(æ–°é«˜è€ƒä¸“ä¸šçœä»½)'] || ''
                                        }
                                    });
                                });
                                
                                updatePlanScoreStats();
                                initPlanScoreFilters();
                                displayPlanScoreResults();
                                document.getElementById('exportPlanScoreBtn').style.display = 'inline-block';
                                document.getElementById('exportUnmatchedPlanScoreBtn').style.display = 'inline-block';
                                showResultSection();
                                switchTab('planScoreTab');
                                console.log('æ¯”å¯¹1å®Œæˆ');
                                onComparisonComplete();
                                break;
                                
                            case 'planVsCollege':
                                // æ‰§è¡Œæ¯”å¯¹2
                                planCollegeResults = [];
                                const collegeKeySet = new Set();
                                
                                collegeData.forEach(item => {
                                    const key = generatePlanCollegeKey(item);
                                    collegeKeySet.add(key);
                                });
                                
                                planData.forEach((item, index) => {
                                    const key = generatePlanCollegeKey(item);
                                    const exists = collegeKeySet.has(key);
                                    
                                    planCollegeResults.push({
                                        index: index + 1,
                                        originalIndex: index,
                                        keyFields: {
                                            å¹´ä»½: item['å¹´ä»½'] || '',
                                            çœä»½: item['çœä»½'] || '',
                                            å­¦æ ¡: item['å­¦æ ¡'] || '',
                                            ç§‘ç±»: item['ç§‘ç±»'] || '',
                                            æ‰¹æ¬¡: item['æ‰¹æ¬¡'] || '',
                                            ä¸“ä¸šç»„ä»£ç : item['ä¸“ä¸šç»„ä»£ç '] || ''
                                        },
                                        exists: exists,
                                        otherInfo: {
                                            ä¸“ä¸š: item['ä¸“ä¸š'] || '',
                                            å±‚æ¬¡: item['å±‚æ¬¡'] || '',
                                            æ‹›ç”Ÿäººæ•°: item['æ‹›ç”Ÿäººæ•°'] || '',
                                            å­¦è´¹: item['å­¦è´¹'] || '',
                                            å­¦åˆ¶: item['å­¦åˆ¶'] || '',
                                            ä¸“ä¸šä»£ç : item['ä¸“ä¸šä»£ç '] || '',
                                            æ‹›ç”Ÿä»£ç : item['æ‹›ç”Ÿä»£ç '] || '',
                                            æ•°æ®æ¥æº: item['æ•°æ®æ¥æº'] || '',
                                            å¤‡æ³¨: item['å¤‡æ³¨'] || '',
                                            æ‹›ç”Ÿç±»å‹: item['æ‹›ç”Ÿç±»å‹'] || '',
                                            ä¸“ä¸šç»„é€‰ç§‘è¦æ±‚: item['ä¸“ä¸šç»„é€‰ç§‘è¦æ±‚'] || '',
                                            ä¸“ä¸šé€‰ç§‘è¦æ±‚: item['ä¸“ä¸šé€‰ç§‘è¦æ±‚(æ–°é«˜è€ƒä¸“ä¸šçœä»½)'] || ''
                                        }
                                    });
                                });
                                
                                updatePlanCollegeStats();
                                initPlanCollegeFilters();
                                displayPlanCollegeResults();
                                document.getElementById('exportPlanCollegeBtn').style.display = 'inline-block';
                                document.getElementById('exportUnmatchedPlanCollegeBtn').style.display = 'inline-block';
                                showResultSection();
                                console.log('æ¯”å¯¹2å®Œæˆ');
                                onComparisonComplete();
                                break;
                        }
                    } catch (error) {
                        console.error(`æ‰§è¡Œæ¯”å¯¹ ${comparison} æ—¶å‘ç”Ÿé”™è¯¯:`, error);
                        onComparisonComplete();
                    }
                }, index * 500);
            });
        }
        
        // å‡†å¤‡è½¬æ¢æ•°æ®
        function prepareConversion(source) {
            conversionSource = source;
            let unmatchedResults = [];
            let sourceName = '';
            
            if (source === 'planScore') {
                unmatchedResults = planScoreResults.filter(r => !r.exists);
                sourceName = 'æ‹›ç”Ÿè®¡åˆ’ vs ä¸“ä¸šåˆ†';
            } else if (source === 'planCollege') {
                unmatchedResults = planCollegeResults.filter(r => !r.exists);
                sourceName = 'æ‹›ç”Ÿè®¡åˆ’ vs é™¢æ ¡åˆ†';
            }
            
            if (unmatchedResults.length === 0) {
                alert('æ²¡æœ‰æœªåŒ¹é…çš„æ•°æ®å¯ä»¥è½¬æ¢');
                return;
            }
            
            // æå–åŸå§‹æ•°æ®
            conversionData = unmatchedResults.map(result => {
                return planData[result.originalIndex];
            });
            
            // æ›´æ–°è½¬æ¢ç»Ÿè®¡ä¿¡æ¯
            updateConversionStats();
            
            // æ˜¾ç¤ºè½¬æ¢åŒºåŸŸ
            document.getElementById('conversionSection').style.display = 'block';
            document.getElementById('conversionSection').scrollIntoView({ behavior: 'smooth' });
            
            // æ›´æ–°å·¥ä½œæµæ­¥éª¤
            updateWorkflowStep(3);
        }
        
        // æ›´æ–°è½¬æ¢ç»Ÿè®¡ä¿¡æ¯
        function updateConversionStats() {
            if (conversionData.length === 0) return;
            
            const yearSet = new Set();
            const provinceSet = new Set();
            
            conversionData.forEach(item => {
                if (item['å¹´ä»½']) yearSet.add(item['å¹´ä»½']);
                if (item['çœä»½']) provinceSet.add(item['çœä»½']);
            });
            
            const years = Array.from(yearSet);
            const provinces = Array.from(provinceSet);
            
            document.getElementById('conversionTotal').textContent = conversionData.length;
            document.getElementById('conversionType').textContent = conversionSource === 'planScore' ? 'æ¯”å¯¹1æœªåŒ¹é…' : 'æ¯”å¯¹2æœªåŒ¹é…';
            document.getElementById('conversionYear').textContent = years.length > 0 ? years.join(', ') : '-';
            document.getElementById('conversionProvinceCount').textContent = provinces.length;
        }
        
        // è½¬æ¢å¹¶å¯¼å‡ºæœªåŒ¹é…æ•°æ®
        function convertAndExportUnmatchedData() {
            if (conversionData.length === 0) {
                alert('æ²¡æœ‰å¯è½¬æ¢çš„æ•°æ®');
                return;
            }
            
            startLoading('æ­£åœ¨è½¬æ¢æ•°æ®ä¸ºä¸“ä¸šåˆ†æ ¼å¼...');
            
            setTimeout(() => {
                try {
                    // è½¬æ¢æ•°æ®
                    convertedData = convertData(conversionData);
                    
                    // å¯¼å‡ºä¸ºExcel
                    exportConvertedDataToExcel(convertedData);
                    
                    stopLoading();
                    alert(`è½¬æ¢å®Œæˆï¼å…±è½¬æ¢ ${convertedData.length} æ¡æ•°æ®`);
                    
                } catch (error) {
                    stopLoading();
                    alert('è½¬æ¢å¤±è´¥: ' + error.message);
                    console.error('è½¬æ¢é”™è¯¯:', error);
                }
            }, 100);
        }
        
        // é¢„è§ˆè½¬æ¢ç»“æœ
        function previewConversion() {
            if (conversionData.length === 0) {
                alert('æ²¡æœ‰å¯é¢„è§ˆçš„æ•°æ®');
                return;
            }
            
            startLoading('æ­£åœ¨ç”Ÿæˆé¢„è§ˆ...');
            
            setTimeout(() => {
                try {
                    // è½¬æ¢æ•°æ®
                    convertedData = convertData(conversionData);
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    showConversionPreview(convertedData);
                    
                    stopLoading();
                } catch (error) {
                    stopLoading();
                    alert('é¢„è§ˆç”Ÿæˆå¤±è´¥: ' + error.message);
                    console.error('é¢„è§ˆé”™è¯¯:', error);
                }
            }, 100);
        }
        
        // æ˜¾ç¤ºè½¬æ¢é¢„è§ˆ
        function showConversionPreview(data) {
            const previewDiv = document.getElementById('conversionPreview');
            
            if (!data || data.length === 0) {
                previewDiv.innerHTML = '<p style="color:#666; text-align:center;">æ²¡æœ‰æ•°æ®å¯é¢„è§ˆ</p>';
                previewDiv.style.display = 'block';
                return;
            }
            
            let html = `<h4 style="margin-bottom:15px; color:#2c3e50;">è½¬æ¢ç»“æœé¢„è§ˆï¼ˆå‰10è¡Œï¼‰</h4>`;
            html += `<div style="overflow-x:auto;">`;
            html += `<table>`;
            
            // è¡¨å¤´
            const headers = [
                'å­¦æ ¡åç§°', 'çœä»½', 'æ‹›ç”Ÿä¸“ä¸š', 'ä¸€çº§å±‚æ¬¡', 'æ‹›ç”Ÿç§‘ç±»',
                'é¦–é€‰ç§‘ç›®', 'æ‹›ç”Ÿæ‰¹æ¬¡', 'é€‰ç§‘è¦æ±‚', 'æ¬¡é€‰ç§‘ç›®'
            ];
            
            html += `<thead><tr>`;
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += `</tr></thead>`;
            
            // æ•°æ®è¡Œï¼ˆæœ€å¤šæ˜¾ç¤º10è¡Œï¼‰
            html += `<tbody>`;
            const displayCount = Math.min(data.length, 10);
            for (let i = 0; i < displayCount; i++) {
                const row = data[i];
                html += `<tr>`;
                headers.forEach(header => {
                    const cellValue = row[header] || '';
                    const displayValue = cellValue.length > 20 ? 
                        cellValue.substring(0, 17) + '...' : cellValue;
                    html += `<td title="${cellValue}">${displayValue}</td>`;
                });
                html += `</tr>`;
            }
            html += `</tbody></table>`;
            html += `</div>`;
            
            if (data.length > 10) {
                html += `<p style="text-align:center; margin-top:10px; color:#7f8c8d;">
                    ä»…æ˜¾ç¤ºå‰10è¡Œæ•°æ®ï¼Œå…± ${data.length} è¡Œ
                </p>`;
            }
            
            previewDiv.innerHTML = html;
            previewDiv.style.display = 'block';
        }
        
        // è½¬æ¢æ•°æ®ä¸»å‡½æ•°ï¼ˆä»ç¬¬äºŒä¸ªå·¥å…·å¤åˆ¶ï¼‰
        function convertData(sourceData) {
            const converted = [];
            
            sourceData.forEach((row, index) => {
                const newRow = {};
                
                // åŸºç¡€å­—æ®µæ˜ å°„
                newRow['å­¦æ ¡åç§°'] = row['å­¦æ ¡'] || '';
                newRow['çœä»½'] = row['çœä»½'] || '';
                newRow['æ‹›ç”Ÿä¸“ä¸š'] = row['ä¸“ä¸š'] || '';
                newRow['æ‹›ç”Ÿç§‘ç±»'] = row['ç§‘ç±»'] || '';
                newRow['æ‹›ç”Ÿæ‰¹æ¬¡'] = row['æ‰¹æ¬¡'] || '';
                newRow['æ‹›ç”Ÿç±»å‹ï¼ˆé€‰å¡«ï¼‰'] = row['æ‹›ç”Ÿç±»å‹'] || '';
                newRow['ä¸“ä¸šå¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰'] = row['å¤‡æ³¨'] || '';
                newRow['æ‹›ç”Ÿäººæ•°ï¼ˆé€‰å¡«ï¼‰'] = row['æ‹›ç”Ÿäººæ•°'] || '';
                newRow['æ•°æ®æ¥æº'] = row['æ•°æ®æ¥æº'] || '';
                
                // å¤„ç†å±‚æ¬¡å­—æ®µ
                newRow['ä¸€çº§å±‚æ¬¡'] = convertLevel(row['å±‚æ¬¡']);
                
                // å¤„ç†ä»£ç å­—æ®µï¼ˆä¿æŒæ–‡æœ¬æ ¼å¼ï¼‰
                newRow['æ‹›ç”Ÿä»£ç '] = convertToText(row['æ‹›ç”Ÿä»£ç ']);
                newRow['ä¸“ä¸šä»£ç '] = convertToText(row['ä¸“ä¸šä»£ç ']);
                newRow['ä¸“ä¸šç»„ä»£ç '] = convertToText(row['ä¸“ä¸šç»„ä»£ç ']);
                
                // å¤„ç†é¦–é€‰ç§‘ç›®ï¼šæ ¹æ®æ‹›ç”Ÿç§‘ç±»çš„ç¬¬ä¸€ä¸ªå­—
                newRow['é¦–é€‰ç§‘ç›®'] = getFirstSubject(row['ç§‘ç±»']);
                
                // å¤„ç†é€‰ç§‘è¦æ±‚ - ä¿®å¤ç‰ˆï¼šå¤„ç†"å¿…é€‰"æƒ…å†µ
                const { selectionRequirement, secondSubject } = 
                    convertSelectionRequirement(row['ä¸“ä¸šç»„é€‰ç§‘è¦æ±‚'], row['ä¸“ä¸šé€‰ç§‘è¦æ±‚(æ–°é«˜è€ƒä¸“ä¸šçœä»½)']);
                
                newRow['é€‰ç§‘è¦æ±‚'] = selectionRequirement;
                newRow['æ¬¡é€‰ç§‘ç›®'] = secondSubject;
                
                // å…¶ä»–å­—æ®µï¼ˆç•™ç©ºï¼‰
                newRow['ä¸“ä¸šæ–¹å‘ï¼ˆé€‰å¡«ï¼‰'] = '';
                newRow['æœ€é«˜åˆ†'] = '';
                newRow['æœ€ä½åˆ†'] = '';
                newRow['å¹³å‡åˆ†'] = '';
                newRow['æœ€ä½åˆ†ä½æ¬¡ï¼ˆé€‰å¡«ï¼‰'] = '';
                newRow['æœ€ä½åˆ†æ•°åŒºé—´ä½'] = '';
                newRow['æœ€ä½åˆ†æ•°åŒºé—´é«˜'] = '';
                newRow['æœ€ä½åˆ†æ•°åŒºé—´ä½æ¬¡ä½'] = '';
                newRow['æœ€ä½åˆ†æ•°åŒºé—´ä½æ¬¡é«˜'] = '';
                newRow['å½•å–äººæ•°ï¼ˆé€‰å¡«ï¼‰'] = '';
                
                converted.push(newRow);
            });
            
            return converted;
        }
        
        // è·å–é¦–é€‰ç§‘ç›®ï¼šæ ¹æ®æ‹›ç”Ÿç§‘ç±»çš„ç¬¬ä¸€ä¸ªå­—
        function getFirstSubject(category) {
            if (!category) return '';
            
            const categoryStr = String(category);
            
            if (categoryStr.includes('ç‰©ç†ç±»') || categoryStr.includes('ç‰©ç†')) {
                return 'ç‰©';
            } else if (categoryStr.includes('å†å²ç±»') || categoryStr.includes('å†å²')) {
                return 'å†';
            } else {
                return '';
            }
        }
        
        // è½¬æ¢å±‚æ¬¡å­—æ®µ
        function convertLevel(level) {
            if (!level) return '';
            
            const levelStr = String(level).toLowerCase();
            if (levelStr.includes('ä¸“ç§‘') || levelStr.includes('é«˜èŒ')) {
                return 'ä¸“ç§‘(é«˜èŒ)';
            } else if (levelStr.includes('æœ¬ç§‘')) {
                return 'æœ¬ç§‘(æ™®é€š)';
            }
            
            return level;
        }
        
        // æå–å¿…é€‰ç§‘ç›®ï¼ˆæ”¹è¿›ç‰ˆï¼‰
        function extractRequiredSubjects(text) {
            const subjects = [];
            const subjectMap = {
                'ç‰©ç†': 'ç‰©',
                'åŒ–å­¦': 'åŒ–', 
                'ç”Ÿç‰©': 'ç”Ÿ',
                'å†å²': 'å†',
                'åœ°ç†': 'åœ°',
                'æ”¿æ²»': 'æ”¿',
                'æŠ€æœ¯': 'æŠ€'
            };
            
            // æ¸…ç†æ–‡æœ¬ï¼Œç§»é™¤æ‹¬å·å†…å®¹ä»¥ä¾¿æ›´å¥½åœ°åŒ¹é…
            let cleanText = text.replace(/\([^)]*\)/g, '').trim();
            
            // é¦–å…ˆå°è¯•æå–"å¿…é€‰"å‰çš„ç§‘ç›®
            if (cleanText.includes('å¿…é€‰')) {
                // è·å–"å¿…é€‰"å‰é¢çš„éƒ¨åˆ†
                const beforeRequired = cleanText.split('å¿…é€‰')[0];
                
                // å°è¯•åŒ¹é…å¤šç§åˆ†éš”ç¬¦ï¼šé¡¿å·ã€é€—å·ã€ç©ºæ ¼
                const separators = ['ã€', 'ï¼Œ', ',', ' '];
                
                // å°è¯•æŒ‰åˆ†éš”ç¬¦åˆ†å‰²
                for (const sep of separators) {
                    if (beforeRequired.includes(sep)) {
                        const parts = beforeRequired.split(sep).filter(p => p.trim());
                        for (const part of parts) {
                            const trimmedPart = part.trim();
                            for (const [fullName, shortName] of Object.entries(subjectMap)) {
                                if (trimmedPart.includes(fullName) || fullName.includes(trimmedPart)) {
                                    if (!subjects.includes(shortName)) {
                                        subjects.push(shortName);
                                    }
                                }
                            }
                        }
                        break; // ä½¿ç”¨ç¬¬ä¸€ä¸ªåŒ¹é…çš„åˆ†éš”ç¬¦
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ†éš”ç¬¦ï¼Œå°è¯•ç›´æ¥åŒ¹é…æ•´ä¸ªå­—ç¬¦ä¸²
                if (subjects.length === 0) {
                    for (const [fullName, shortName] of Object.entries(subjectMap)) {
                        if (beforeRequired.includes(fullName)) {
                            if (!subjects.includes(shortName)) {
                                subjects.push(shortName);
                            }
                        }
                    }
                }
            }
            
            // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œå°è¯•ä»æ•´ä¸ªæ–‡æœ¬ä¸­æå–ç§‘ç›®
            if (subjects.length === 0) {
                for (const [fullName, shortName] of Object.entries(subjectMap)) {
                    if (cleanText.includes(fullName)) {
                        if (!subjects.includes(shortName)) {
                            subjects.push(shortName);
                        }
                    }
                }
            }
            
            return subjects;
        }

        // è½¬æ¢é€‰ç§‘è¦æ±‚ - æ ¹æ®é™„ä»¶2ç¤ºä¾‹ä¼˜åŒ–
        function convertSelectionRequirement(groupRequirement, majorRequirement) {
            let selectionRequirement = '';
            let secondSubject = '';
            
            // åˆå¹¶ä¸¤ä¸ªè¦æ±‚å­—æ®µ
            let requirement = (groupRequirement || '') + (majorRequirement || '');
            
            // æ¸…ç†ç‰¹æ®Šå­—ç¬¦
            requirement = requirement.replace(/^\^+/, '').replace(/\^+/g, 'ã€').trim();
            
            if (!requirement || requirement === '' || requirement === 'ã€') {
                return { selectionRequirement, secondSubject };
            }
            
            console.log('å¤„ç†é€‰ç§‘è¦æ±‚:', requirement);
            
            // æ ¹æ®é™„ä»¶2ç¤ºä¾‹å¤„ç†å„ç§æƒ…å†µ
            if (requirement.includes('ä¸é™') || requirement.includes('å†é€‰ä¸é™')) {
                selectionRequirement = 'ä¸é™ç§‘ç›®ä¸“ä¸šç»„';
            }
            else if (requirement.includes('å¿…é€‰')) {
                // æå–å¿…é€‰ç§‘ç›®
                const requiredSubjects = extractRequiredSubjects(requirement);
                
                console.log('æå–çš„å¿…é€‰ç§‘ç›®:', requiredSubjects);
                
                if (requiredSubjects.length > 0) {
                    selectionRequirement = 'å•ç§‘ã€å¤šç§‘å‡éœ€é€‰è€ƒ';
                    secondSubject = requiredSubjects.join('');
                }
                
                // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœåŒ…å«"é¦–é€‰"ï¼Œå¯èƒ½éœ€è¦æ’é™¤é¦–é€‰ç§‘ç›®
                if (requirement.includes('é¦–é€‰')) {
                    // ä»å¿…é€‰ç§‘ç›®ä¸­ç§»é™¤é¦–é€‰ç§‘ç›®
                    const preferredSubjects = [];
                    if (requirement.includes('é¦–é€‰ç‰©ç†')) {
                        preferredSubjects.push('ç‰©');
                    }
                    if (requirement.includes('é¦–é€‰å†å²')) {
                        preferredSubjects.push('å†');
                    }
                    
                    // ä»å¿…é€‰ç§‘ç›®ä¸­ç§»é™¤é¦–é€‰ç§‘ç›®
                    const filteredSubjects = requiredSubjects.filter(sub => 
                        !preferredSubjects.includes(sub)
                    );
                    
                    if (filteredSubjects.length > 0) {
                        secondSubject = filteredSubjects.join('');
                    }
                }
            }
            else if (requirement.includes('é¦–é€‰') && requirement.includes('å†é€‰')) {
                // å¤„ç†"é¦–é€‰ç‰©ç†ï¼Œå†é€‰åŒ–å­¦ã€ç”Ÿç‰©"æ ¼å¼
                const reSelectPart = requirement.split('å†é€‰')[1] || '';
                const reSelectSubjects = extractRequiredSubjects(reSelectPart);
                
                if (reSelectSubjects.length > 0) {
                    selectionRequirement = 'å•ç§‘ã€å¤šç§‘å‡éœ€é€‰è€ƒ';
                    secondSubject = reSelectSubjects.join('');
                }
            }
            else if (requirement.includes('æˆ–') || requirement.includes('é€‰1')) {
                // å¤„ç†å¤šé€‰ä¸€æƒ…å†µ
                const subjects = extractRequiredSubjects(requirement);
                const filteredSubjects = subjects.filter(sub => sub !== 'ç‰©' && sub !== 'å†');
                
                if (filteredSubjects.length > 0) {
                    selectionRequirement = 'å¤šé—¨é€‰è€ƒ';
                    secondSubject = filteredSubjects.join('');
                }
            }
            else {
                // é»˜è®¤å¤„ç†
                const subjects = extractRequiredSubjects(requirement);
                if (subjects.length > 0) {
                    const filteredSubjects = subjects.filter(sub => sub !== 'ç‰©' && sub !== 'å†');
                    secondSubject = filteredSubjects.join('');
                    
                    if (filteredSubjects.length > 0) {
                        selectionRequirement = 'å•ç§‘ã€å¤šç§‘å‡éœ€é€‰è€ƒ';
                    }
                }
            }
            
            console.log('è½¬æ¢ç»“æœ:', { selectionRequirement, secondSubject });
            
            return { selectionRequirement, secondSubject };
        }
        
        // æå–ç§‘ç›®ç®€ç§°
        function extractSubjects(text) {
            const subjects = [];
            const subjectMap = {
                'ç‰©ç†': 'ç‰©',
                'åŒ–å­¦': 'åŒ–',
                'ç”Ÿç‰©': 'ç”Ÿ',
                'å†å²': 'å†',
                'åœ°ç†': 'åœ°',
                'æ”¿æ²»': 'æ”¿',
                'æŠ€æœ¯': 'æŠ€'
            };
            
            for (const [fullName, shortName] of Object.entries(subjectMap)) {
                if (text.includes(fullName)) {
                    subjects.push(shortName);
                }
            }
            
            return subjects;
        }
        
        // è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼
        function convertToText(value) {
            if (!value && value !== 0) return '';
            
            let text = String(value).replace(/^\^+/, '').trim();
            
            if (text === '') return '';
            
            text = text.replace(/^'/, '');
            
            return text;
        }
        
        // å¯¼å‡ºè½¬æ¢åçš„æ•°æ®ä¸ºExcel
        function exportConvertedDataToExcel(data) {
            if (!data || data.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }
            
            try {
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                
                // åˆ›å»ºæ•°æ®è¡Œ
                const wsData = [];
                
                // ç¬¬1è¡Œï¼šå¤‡æ³¨ï¼ˆåˆå¹¶å•å…ƒæ ¼ï¼‰
                const remarkText = `å¤‡æ³¨ï¼šè¯·åˆ é™¤ç¤ºä¾‹åå†å¡«å†™ï¼›
1.çœä»½ï¼šå¿…é¡»å¡«å†™å„çœä»½ç®€ç§°ï¼Œä¾‹å¦‚ï¼šåŒ—äº¬ã€å†…è’™å¤ï¼Œä¸èƒ½å¸¦æœ‰å¸‚ã€çœã€è‡ªæ²»åŒºã€ç©ºæ ¼ã€ç‰¹æ®Šå­—ç¬¦ç­‰
2.ç§‘ç±»ï¼šæµ™æ±Ÿã€ä¸Šæµ·é™å®š"ç»¼åˆã€è‰ºæœ¯ç±»ã€ä½“è‚²ç±»"ï¼Œå†…è’™å¤é™å®š"æ–‡ç§‘ã€ç†ç§‘ã€è’™æˆæ–‡ç§‘ã€è’™æˆç†ç§‘ã€è‰ºæœ¯ç±»ã€è‰ºæœ¯æ–‡ã€è‰ºæœ¯ç†ã€ä½“è‚²ç±»ã€ä½“è‚²æ–‡ã€ä½“è‚²ç†ã€è’™æˆè‰ºæœ¯ã€è’™æˆä½“è‚²"ï¼Œå…¶ä»–çœä»½é™å®š"æ–‡ç§‘ã€ç†ç§‘ã€è‰ºæœ¯ç±»ã€è‰ºæœ¯æ–‡ã€è‰ºæœ¯ç†ã€ä½“è‚²ç±»ã€ä½“è‚²æ–‡ã€ä½“è‚²ç†"
3.æ‰¹æ¬¡ï¼šï¼ˆä»¥ä¸‹ä¸º19å¹´ä½¿ç”¨æ‰¹æ¬¡ï¼‰
æ²³åŒ—ã€å†…è’™å¤ã€å‰æ—ã€æ±Ÿè‹ã€å®‰å¾½ã€ç¦å»ºã€æ±Ÿè¥¿ã€æ²³å—ã€æ¹–åŒ—ã€å¹¿è¥¿ã€é‡åº†ã€å››å·ã€è´µå·ã€äº‘å—ã€è¥¿è—ã€é™•è¥¿ã€ç”˜è‚ƒã€å®å¤ã€æ–°ç–†é™å®šæœ¬ç§‘æå‰æ‰¹ã€æœ¬ç§‘ä¸€æ‰¹ã€æœ¬ç§‘äºŒæ‰¹ã€ä¸“ç§‘æå‰æ‰¹ã€ä¸“ç§‘æ‰¹ã€å›½å®¶ä¸“é¡¹è®¡åˆ’æœ¬ç§‘æ‰¹ã€åœ°æ–¹ä¸“é¡¹è®¡åˆ’æœ¬ç§‘æ‰¹ï¼›
é»‘é¾™æ±Ÿã€æ¹–å—ã€é’æµ·é™å®šæœ¬ç§‘æå‰æ‰¹ã€æœ¬ç§‘ä¸€æ‰¹ã€æœ¬ç§‘äºŒæ‰¹ã€æœ¬ç§‘ä¸‰æ‰¹ã€ä¸“ç§‘æå‰æ‰¹ã€ä¸“ç§‘æ‰¹ã€å›½å®¶ä¸“é¡¹è®¡åˆ’æœ¬ç§‘æ‰¹ã€åœ°æ–¹ä¸“é¡¹è®¡åˆ’æœ¬ç§‘æ‰¹ï¼›
å±±è¥¿é™å®šæœ¬ç§‘ä¸€æ‰¹Aæ®µã€æœ¬ç§‘ä¸€æ‰¹Bæ®µã€æœ¬ç§‘äºŒæ‰¹Aæ®µã€æœ¬ç§‘äºŒæ‰¹Bæ®µã€æœ¬ç§‘äºŒæ‰¹Cæ®µã€ä¸“ç§‘æ‰¹ã€å›½å®¶ä¸“é¡¹è®¡åˆ’æœ¬ç§‘æ‰¹ã€åœ°æ–¹ä¸“é¡¹è®¡åˆ’æœ¬ç§‘æ‰¹ï¼›
æµ™æ±Ÿé™å®šæ™®é€šç±»æå‰æ‰¹ã€å¹³è¡Œå½•å–ä¸€æ®µã€å¹³è¡Œå½•å–äºŒæ®µã€å¹³è¡Œå½•å–ä¸‰æ®µ
4.æ‹›ç”Ÿäººæ•°ï¼šä»…èƒ½å¡«å†™æ•°å­—
5.æœ€é«˜åˆ†ã€æœ€ä½åˆ†ã€å¹³å‡åˆ†ï¼šä»…èƒ½å¡«å†™æ•°å­—ï¼Œä¿ç•™å°æ•°åä¸¤ä½ï¼Œä¸”ä¸‰è€…é¡ºåºä¸èƒ½æ”¹å˜ï¼Œæœ€ä½åˆ†ä¸ºå¿…å¡«é¡¹ï¼Œå…¶ä¸­è‰ºæœ¯ç±»å’Œä½“è‚²ç±»åˆ†æ•°ä¸ºæ–‡åŒ–è¯¾åˆ†æ•°
6.ä¸€çº§å±‚æ¬¡ï¼šé™å®š"æœ¬ç§‘ã€ä¸“ç§‘ï¼ˆé«˜èŒï¼‰"ï¼Œè¯¥éƒ¨åˆ†ä¸ºæ‹›ç”Ÿä¸“ä¸šå¯¹åº”çš„ä¸“ä¸šå±‚æ¬¡
7.æœ€ä½åˆ†ä½æ¬¡ï¼šä»…èƒ½å¡«å†™æ•°å­—;
8.æ•°æ®æ¥æºï¼šå¿…é¡»é™å®šâ€”â€”å®˜æ–¹è€ƒè¯•é™¢ã€å¤§çº¢æœ¬æ•°æ®ã€å­¦æ ¡å®˜ç½‘ã€é”€å”®ã€æŠ“å–ã€åœ£è¾¾ä¿¡ã€ä¼˜å¿—æ„¿ã€å­¦ä¸šæ¡¥
9.é€‰ç§‘è¦æ±‚ï¼šä¸é™ç§‘ç›®ä¸“ä¸šç»„;å¤šé—¨é€‰è€ƒ;å•ç§‘ã€å¤šç§‘å‡éœ€é€‰è€ƒ
10.é€‰ç§‘ç§‘ç›®å¿…é¡»æ˜¯ç§‘ç›®çš„ç®€å†™ï¼ˆç‰©ã€åŒ–ã€ç”Ÿã€å†ã€åœ°ã€æ”¿ã€æŠ€ï¼‰

11.2020åŒ—äº¬ã€æµ·å—ï¼Œ17-19ä¸Šæµ·ä»…é™åˆ¶æœ¬ç§‘ä¸“ä¸šç»„ä»£ç å¿…å¡«
12.æ–°å…«çœé¦–é€‰ç§‘ç›®å¿…é¡»é€‰æ‹©ï¼ˆç‰©ç†æˆ–å†å²ï¼‰
13.åˆ†æ•°åŒºé—´ä»…é™åŒ—äº¬`;
                
                wsData.push([remarkText]);
                
                // ç¬¬2è¡Œï¼šæ‹›ç”Ÿå¹´ä»½
                let admissionYear = '';
                if (conversionData.length > 0 && conversionData[0]['å¹´ä»½']) {
                    admissionYear = conversionData[0]['å¹´ä»½'];
                }
                wsData.push(['æ‹›ç”Ÿå¹´ä»½', admissionYear]);
                
                // ç¬¬3è¡Œï¼šè¡¨å¤´
                const headers = [
                    'å­¦æ ¡åç§°', 'çœä»½', 'æ‹›ç”Ÿä¸“ä¸š', 'ä¸“ä¸šæ–¹å‘ï¼ˆé€‰å¡«ï¼‰', 'ä¸“ä¸šå¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰', 
                    'ä¸€çº§å±‚æ¬¡', 'æ‹›ç”Ÿç§‘ç±»', 'æ‹›ç”Ÿæ‰¹æ¬¡', 'æ‹›ç”Ÿç±»å‹ï¼ˆé€‰å¡«ï¼‰', 'æœ€é«˜åˆ†', 
                    'æœ€ä½åˆ†', 'å¹³å‡åˆ†', 'æœ€ä½åˆ†ä½æ¬¡ï¼ˆé€‰å¡«ï¼‰', 'æ‹›ç”Ÿäººæ•°ï¼ˆé€‰å¡«ï¼‰', 
                    'æ•°æ®æ¥æº', 'ä¸“ä¸šç»„ä»£ç ', 'é¦–é€‰ç§‘ç›®', 'é€‰ç§‘è¦æ±‚', 'æ¬¡é€‰ç§‘ç›®', 
                    'ä¸“ä¸šä»£ç ', 'æ‹›ç”Ÿä»£ç ', 'æœ€ä½åˆ†æ•°åŒºé—´ä½', 'æœ€ä½åˆ†æ•°åŒºé—´é«˜', 
                    'æœ€ä½åˆ†æ•°åŒºé—´ä½æ¬¡ä½', 'æœ€ä½åˆ†æ•°åŒºé—´ä½æ¬¡é«˜', 'å½•å–äººæ•°ï¼ˆé€‰å¡«ï¼‰'
                ];
                wsData.push(headers);
                
                // æ•°æ®è¡Œ
                data.forEach(row => {
                    const rowData = headers.map(header => {
                        const value = row[header];
                        return value || '';
                    });
                    wsData.push(rowData);
                });
                
                // åˆ›å»ºå·¥ä½œè¡¨
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // è®¾ç½®åˆå¹¶å•å…ƒæ ¼ï¼ˆç¬¬ä¸€è¡Œåˆå¹¶A1~Y1ï¼‰
                if (!ws['!merges']) ws['!merges'] = [];
                ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 24 } });
                
                // è®¾ç½®åˆ—å®½
                const colWidths = [];
                for (let i = 0; i < headers.length; i++) {
                    colWidths.push({ wch: 9.36 });
                }
                ws['!cols'] = colWidths;
                
                // è®¾ç½®è¡Œé«˜ï¼ˆç¬¬ä¸€è¡Œ350ç£…ï¼‰
                if (!ws['!rows']) ws['!rows'] = [];
                ws['!rows'][0] = { hpt: 350 };
                
                // å°†å·¥ä½œè¡¨æ·»åŠ åˆ°å·¥ä½œç°¿
                XLSX.utils.book_append_sheet(wb, ws, 'ä¸“ä¸šåˆ†æ•°æ®');
                
                // ç”Ÿæˆæ–‡ä»¶
                const wbout = XLSX.write(wb, { 
                    bookType: 'xlsx', 
                    type: 'binary',
                    bookSST: false
                });
                
                // è½¬æ¢ä¸ºBlob
                const buffer = new ArrayBuffer(wbout.length);
                const view = new Uint8Array(buffer);
                for (let i = 0; i < wbout.length; i++) {
                    view[i] = wbout.charCodeAt(i) & 0xFF;
                }
                
                const blob = new Blob([buffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                // ç”Ÿæˆæ–‡ä»¶å
                const dateStr = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                const fileName = `ä¸“ä¸šåˆ†æ•°æ®_æœªåŒ¹é…æ•°æ®_${dateStr}.xlsx`;
                
                // ä¸‹è½½æ–‡ä»¶
                saveAs(blob, fileName);
                
                alert(`æ–‡ä»¶å·²å¯¼å‡º: ${fileName}`);
                
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
                console.error('å¯¼å‡ºé”™è¯¯:', error);
            }
        }
        
        // å¯¼å‡ºæ¯”å¯¹1ä¸­æœªåŒ¹é…æ•°æ®ä¸ºä¸“ä¸šåˆ†æ ¼å¼
        function exportUnmatchedPlanScoreAsScore() {
            const unmatchedResults = planScoreResults.filter(r => !r.exists);
            if (unmatchedResults.length === 0) {
                alert('æ¯”å¯¹1ä¸­æ²¡æœ‰æœªåŒ¹é…çš„æ•°æ®');
                return;
            }
            
            // æå–åŸå§‹æ•°æ®
            conversionData = unmatchedResults.map(result => {
                return planData[result.originalIndex];
            });
            
            conversionSource = 'planScore';
            
            // æ›´æ–°è½¬æ¢ç»Ÿè®¡ä¿¡æ¯
            updateConversionStats();
            
            // æ˜¾ç¤ºè½¬æ¢åŒºåŸŸ
            document.getElementById('conversionSection').style.display = 'block';
            document.getElementById('conversionSection').scrollIntoView({ behavior: 'smooth' });
            
            // æ›´æ–°å·¥ä½œæµæ­¥éª¤
            updateWorkflowStep(3);
            
            alert(`å·²æå– ${unmatchedResults.length} æ¡æœªåŒ¹é…æ•°æ®ï¼Œè¯·ç‚¹å‡»"è½¬æ¢å¹¶å¯¼å‡ºä¸ºä¸“ä¸šåˆ†æ ¼å¼"æŒ‰é’®`);
        }
        
        // å¯¼å‡ºæ¯”å¯¹2ä¸­æœªåŒ¹é…æ•°æ®ä¸ºä¸“ä¸šåˆ†æ ¼å¼
        function exportUnmatchedPlanCollegeAsScore() {
            const unmatchedResults = planCollegeResults.filter(r => !r.exists);
            if (unmatchedResults.length === 0) {
                alert('æ¯”å¯¹2ä¸­æ²¡æœ‰æœªåŒ¹é…çš„æ•°æ®');
                return;
            }
            
            // æå–åŸå§‹æ•°æ®
            conversionData = unmatchedResults.map(result => {
                return planData[result.originalIndex];
            });
            
            conversionSource = 'planCollege';
            
            // æ›´æ–°è½¬æ¢ç»Ÿè®¡ä¿¡æ¯
            updateConversionStats();
            
            // æ˜¾ç¤ºè½¬æ¢åŒºåŸŸ
            document.getElementById('conversionSection').style.display = 'block';
            document.getElementById('conversionSection').scrollIntoView({ behavior: 'smooth' });
            
            // æ›´æ–°å·¥ä½œæµæ­¥éª¤
            updateWorkflowStep(3);
            
            alert(`å·²æå– ${unmatchedResults.length} æ¡æœªåŒ¹é…æ•°æ®ï¼Œè¯·ç‚¹å‡»"è½¬æ¢å¹¶å¯¼å‡ºä¸ºä¸“ä¸šåˆ†æ ¼å¼"æŒ‰é’®`);
        }
        
        // ä»¥ä¸‹ä¸ºåŸæœ‰æ¯”å¯¹å·¥å…·çš„åŠŸèƒ½ï¼ˆæ›´æ–°ç»Ÿè®¡ã€ç­›é€‰ã€æ˜¾ç¤ºç­‰ï¼‰
        // ç”±äºä»£ç è¾ƒé•¿ï¼Œè¿™é‡Œåªä¿ç•™å‡½æ•°å£°æ˜ï¼Œå…·ä½“å®ç°ä¸åŸå§‹æ¯”å¯¹å·¥å…·ç›¸åŒ
        
        function updatePlanScoreStats() {
            const filteredResults = getFilteredPlanScoreResults();
            const total = filteredResults.length;
            const matched = filteredResults.filter(r => r.exists).length;
            const unmatched = total - matched;
            
            document.getElementById('planScoreTotal').textContent = total;
            document.getElementById('planScoreMatched').textContent = matched;
            document.getElementById('planScoreUnmatched').textContent = unmatched;
            document.getElementById('planScoreRate').textContent = total > 0 ? 
                ((matched / total * 100).toFixed(1) + '%') : '0%';
        }
        
        function getFilteredPlanScoreResults() {
            let filtered = planScoreResults;
            
            if (planScoreFilterState.province !== 'all' && planScoreFilterState.province !== '') {
                filtered = filtered.filter(result => result.keyFields.çœä»½ === planScoreFilterState.province);
            }
            
            if (planScoreFilterState.batch !== 'all' && planScoreFilterState.batch !== '') {
                filtered = filtered.filter(result => result.keyFields.æ‰¹æ¬¡ === planScoreFilterState.batch);
            }
            
            if (planScoreFilterState.matchStatus === 'matched') {
                filtered = filtered.filter(result => result.exists);
            } else if (planScoreFilterState.matchStatus === 'unmatched') {
                filtered = filtered.filter(result => !result.exists);
            }
            
            return filtered;
        }
        
        function initPlanScoreFilters() {
            const provinceList = document.getElementById('planScoreProvinceList');
            if (provinceList) {
                provinceList.innerHTML = '<option value="å…¨éƒ¨çœä»½">';
                const provinces = [...new Set(planScoreResults.map(result => result.keyFields.çœä»½).filter(province => province))].sort();
                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    provinceList.appendChild(option);
                });
            }
            
            const batchList = document.getElementById('planScoreBatchList');
            if (batchList) {
                batchList.innerHTML = '<option value="å…¨éƒ¨æ‰¹æ¬¡">';
                const batches = [...new Set(planScoreResults.map(result => result.keyFields.æ‰¹æ¬¡).filter(batch => batch))].sort();
                batches.forEach(batch => {
                    const option = document.createElement('option');
                    option.value = batch;
                    batchList.appendChild(option);
                });
            }
        }
        
        function applyPlanScoreFilter() {
            const provinceFilter = document.getElementById('planScoreProvinceFilter');
            const batchFilter = document.getElementById('planScoreBatchFilter');
            const matchStatusFilter = document.getElementById('planScoreMatchStatusFilter');
            const displayOption = document.getElementById('planScoreDisplayOption');
            
            planScoreFilterState.province = provinceFilter.value === '' ? 'all' : provinceFilter.value;
            planScoreFilterState.batch = batchFilter.value === '' ? 'all' : batchFilter.value;
            planScoreFilterState.matchStatus = matchStatusFilter.value;
            planScoreFilterState.displayOption = displayOption.value;
            
            updatePlanScoreStats();
            displayPlanScoreResults();
            updatePlanScoreCurrentFilter();
        }
        
        function resetPlanScoreFilter() {
            document.getElementById('planScoreProvinceFilter').value = '';
            document.getElementById('planScoreBatchFilter').value = '';
            document.getElementById('planScoreMatchStatusFilter').value = 'all';
            document.getElementById('planScoreDisplayOption').value = 'all';
            
            planScoreFilterState.province = 'all';
            planScoreFilterState.batch = 'all';
            planScoreFilterState.matchStatus = 'all';
            planScoreFilterState.displayOption = 'all';
            
            updatePlanScoreStats();
            displayPlanScoreResults();
            document.getElementById('planScoreCurrentFilter').style.display = 'none';
        }
        
        function updatePlanScoreCurrentFilter() {
            const currentFilterDiv = document.getElementById('planScoreCurrentFilter');
            let filterText = '';
            
            const filters = [];
            
            if (planScoreFilterState.province !== 'all' && planScoreFilterState.province !== '') {
                filters.push(`çœä»½: ${planScoreFilterState.province}`);
            }
            
            if (planScoreFilterState.batch !== 'all' && planScoreFilterState.batch !== '') {
                filters.push(`æ‰¹æ¬¡: ${planScoreFilterState.batch}`);
            }
            
            if (planScoreFilterState.matchStatus !== 'all') {
                filters.push(`åŒ¹é…çŠ¶æ€: ${planScoreFilterState.matchStatus === 'matched' ? 'åŒ¹é…' : 'æœªåŒ¹é…'}`);
            }
            
            if (planScoreFilterState.displayOption === '100') {
                filters.push('ä»…æ˜¾ç¤ºå‰100æ¡è®°å½•');
            } else if (planScoreFilterState.displayOption === '500') {
                filters.push('ä»…æ˜¾ç¤ºå‰500æ¡è®°å½•');
            } else {
                filters.push('æ˜¾ç¤ºå…¨éƒ¨è®°å½•');
            }
            
            if (filters.length > 0) {
                filterText = 'å½“å‰ç­›é€‰: ' + filters.join(' | ');
                currentFilterDiv.textContent = filterText;
                currentFilterDiv.style.display = 'block';
            } else {
                currentFilterDiv.style.display = 'none';
            }
        }
        
        function updatePlanCollegeStats() {
            const filteredResults = getFilteredPlanCollegeResults();
            const total = filteredResults.length;
            const matched = filteredResults.filter(r => r.exists).length;
            const unmatched = total - matched;
            
            document.getElementById('planCollegeTotal').textContent = total;
            document.getElementById('planCollegeMatched').textContent = matched;
            document.getElementById('planCollegeUnmatched').textContent = unmatched;
            document.getElementById('planCollegeRate').textContent = total > 0 ? 
                ((matched / total * 100).toFixed(1) + '%') : '0%';
        }
        
        function getFilteredPlanCollegeResults() {
            let filtered = planCollegeResults;
            
            if (planCollegeFilterState.province !== 'all' && planCollegeFilterState.province !== '') {
                filtered = filtered.filter(result => result.keyFields.çœä»½ === planCollegeFilterState.province);
            }
            
            if (planCollegeFilterState.batch !== 'all' && planCollegeFilterState.batch !== '') {
                filtered = filtered.filter(result => result.keyFields.æ‰¹æ¬¡ === planCollegeFilterState.batch);
            }
            
            if (planCollegeFilterState.matchStatus === 'matched') {
                filtered = filtered.filter(result => result.exists);
            } else if (planCollegeFilterState.matchStatus === 'unmatched') {
                filtered = filtered.filter(result => !result.exists);
            }
            
            return filtered;
        }
        
        function initPlanCollegeFilters() {
            const provinceList = document.getElementById('planCollegeProvinceList');
            if (provinceList) {
                provinceList.innerHTML = '<option value="å…¨éƒ¨çœä»½">';
                const provinces = [...new Set(planCollegeResults.map(result => result.keyFields.çœä»½).filter(province => province))].sort();
                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    provinceList.appendChild(option);
                });
            }
            
            const batchList = document.getElementById('planCollegeBatchList');
            if (batchList) {
                batchList.innerHTML = '<option value="å…¨éƒ¨æ‰¹æ¬¡">';
                const batches = [...new Set(planCollegeResults.map(result => result.keyFields.æ‰¹æ¬¡).filter(batch => batch))].sort();
                batches.forEach(batch => {
                    const option = document.createElement('option');
                    option.value = batch;
                    batchList.appendChild(option);
                });
            }
        }
        
        function applyPlanCollegeFilter() {
            const provinceFilter = document.getElementById('planCollegeProvinceFilter');
            const batchFilter = document.getElementById('planCollegeBatchFilter');
            const matchStatusFilter = document.getElementById('planCollegeMatchStatusFilter');
            const displayOption = document.getElementById('planCollegeDisplayOption');
            
            planCollegeFilterState.province = provinceFilter.value === '' ? 'all' : provinceFilter.value;
            planCollegeFilterState.batch = batchFilter.value === '' ? 'all' : batchFilter.value;
            planCollegeFilterState.matchStatus = matchStatusFilter.value;
            planCollegeFilterState.displayOption = displayOption.value;
            
            updatePlanCollegeStats();
            displayPlanCollegeResults();
            updatePlanCollegeCurrentFilter();
        }
        
        function resetPlanCollegeFilter() {
            document.getElementById('planCollegeProvinceFilter').value = '';
            document.getElementById('planCollegeBatchFilter').value = '';
            document.getElementById('planCollegeMatchStatusFilter').value = 'all';
            document.getElementById('planCollegeDisplayOption').value = 'all';
            
            planCollegeFilterState.province = 'all';
            planCollegeFilterState.batch = 'all';
            planCollegeFilterState.matchStatus = 'all';
            planCollegeFilterState.displayOption = 'all';
            
            updatePlanCollegeStats();
            displayPlanCollegeResults();
            document.getElementById('planCollegeCurrentFilter').style.display = 'none';
        }
        
        function updatePlanCollegeCurrentFilter() {
            const currentFilterDiv = document.getElementById('planCollegeCurrentFilter');
            let filterText = '';
            
            const filters = [];
            
            if (planCollegeFilterState.province !== 'all' && planCollegeFilterState.province !== '') {
                filters.push(`çœä»½: ${planCollegeFilterState.province}`);
            }
            
            if (planCollegeFilterState.batch !== 'all' && planCollegeFilterState.batch !== '') {
                filters.push(`æ‰¹æ¬¡: ${planCollegeFilterState.batch}`);
            }
            
            if (planCollegeFilterState.matchStatus !== 'all') {
                filters.push(`åŒ¹é…çŠ¶æ€: ${planCollegeFilterState.matchStatus === 'matched' ? 'åŒ¹é…' : 'æœªåŒ¹é…'}`);
            }
            
            if (planCollegeFilterState.displayOption === '100') {
                filters.push('ä»…æ˜¾ç¤ºå‰100æ¡è®°å½•');
            } else if (planCollegeFilterState.displayOption === '500') {
                filters.push('ä»…æ˜¾ç¤ºå‰500æ¡è®°å½•');
            } else {
                filters.push('æ˜¾ç¤ºå…¨éƒ¨è®°å½•');
            }
            
            if (filters.length > 0) {
                filterText = 'å½“å‰ç­›é€‰: ' + filters.join(' | ');
                currentFilterDiv.textContent = filterText;
                currentFilterDiv.style.display = 'block';
            } else {
                currentFilterDiv.style.display = 'none';
            }
        }
        
        function displayPlanScoreResults() {
            const tableContainer = document.getElementById('planScoreResultsTable');
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th width="50">åºå·</th>
                            <th width="100">å¹´ä»½</th>
                            <th width="80">çœä»½</th>
                            <th width="150">å­¦æ ¡</th>
                            <th width="60">ç§‘ç±»</th>
                            <th width="80">æ‰¹æ¬¡</th>
                            <th width="150">ä¸“ä¸š</th>
                            <th width="80">å±‚æ¬¡</th>
                            <th width="100">ä¸“ä¸šç»„ä»£ç </th>
                            <th width="100">æ‹›ç”Ÿäººæ•°</th>
                            <th width="100">åŒ¹é…çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const filteredResults = getFilteredPlanScoreResults();
            
            let displayCount = filteredResults.length;
            if (planScoreFilterState.displayOption === '100' && filteredResults.length > 100) {
                displayCount = 100;
            } else if (planScoreFilterState.displayOption === '500' && filteredResults.length > 500) {
                displayCount = 500;
            }
            
            for (let i = 0; i < displayCount; i++) {
                const result = filteredResults[i];
                const fields = result.keyFields;
                
                html += `
                    <tr>
                        <td>${result.index}</td>
                        <td>${fields.å¹´ä»½}</td>
                        <td>${fields.çœä»½}</td>
                        <td title="${fields.å­¦æ ¡}">${fields.å­¦æ ¡.length > 8 ? fields.å­¦æ ¡.substring(0, 8) + '...' : fields.å­¦æ ¡}</td>
                        <td>${fields.ç§‘ç±»}</td>
                        <td>${fields.æ‰¹æ¬¡}</td>
                        <td title="${fields.ä¸“ä¸š}">${fields.ä¸“ä¸š.length > 10 ? fields.ä¸“ä¸š.substring(0, 10) + '...' : fields.ä¸“ä¸š}</td>
                        <td>${fields.å±‚æ¬¡}</td>
                        <td>${fields.ä¸“ä¸šç»„ä»£ç  || '-'}</td>
                        <td>${result.otherInfo.æ‹›ç”Ÿäººæ•° || '-'}</td>
                        <td>
                            <span class="${result.exists ? 'status-exists' : 'status-not-exists'}">
                                ${result.exists ? 'âœ“ å­˜åœ¨' : 'âœ— ä¸å­˜åœ¨'}
                            </span>
                        </td>
                    </tr>
                `;
            }
            
            html += `</tbody></table>`;
            
            if ((planScoreFilterState.displayOption === '100' && filteredResults.length > 100) || 
                (planScoreFilterState.displayOption === '500' && filteredResults.length > 500)) {
                const limit = planScoreFilterState.displayOption === '100' ? 100 : 500;
                html += `<p style="text-align:center; margin-top:10px; color:#7f8c8d;">
                    ä»…æ˜¾ç¤ºå‰${limit}æ¡è®°å½•ï¼Œå…±${filteredResults.length}æ¡è®°å½•ã€‚å¯¼å‡ºExcelæŸ¥çœ‹å…¨éƒ¨ç»“æœï¼Œæˆ–é€‰æ‹©"æ˜¾ç¤ºå…¨éƒ¨è®°å½•"æŸ¥çœ‹æ‰€æœ‰æ•°æ®ã€‚
                </p>`;
            } else if (filteredResults.length > 500) {
                html += `<p style="text-align:center; margin-top:10px; color:#7f8c8d;">
                    å½“å‰æ˜¾ç¤º${filteredResults.length}æ¡è®°å½•ã€‚æ•°æ®é‡è¾ƒå¤§ï¼Œå»ºè®®ä½¿ç”¨ç­›é€‰åŠŸèƒ½æŸ¥çœ‹ç‰¹å®šæ•°æ®ã€‚
                </p>`;
            }
            
            tableContainer.innerHTML = html;
        }
        
        function displayPlanCollegeResults() {
            const tableContainer = document.getElementById('planCollegeResultsTable');
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th width="50">åºå·</th>
                            <th width="100">å¹´ä»½</th>
                            <th width="80">çœä»½</th>
                            <th width="150">å­¦æ ¡</th>
                            <th width="60">ç§‘ç±»</th>
                            <th width="80">æ‰¹æ¬¡</th>
                            <th width="100">ä¸“ä¸šç»„ä»£ç </th>
                            <th width="100">ä¸“ä¸š</th>
                            <th width="100">åŒ¹é…çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const filteredResults = getFilteredPlanCollegeResults();
            
            let displayCount = filteredResults.length;
            if (planCollegeFilterState.displayOption === '100' && filteredResults.length > 100) {
                displayCount = 100;
            } else if (planCollegeFilterState.displayOption === '500' && filteredResults.length > 500) {
                displayCount = 500;
            }
            
            for (let i = 0; i < displayCount; i++) {
                const result = filteredResults[i];
                const fields = result.keyFields;
                
                html += `
                    <tr>
                        <td>${result.index}</td>
                        <td>${fields.å¹´ä»½}</td>
                        <td>${fields.çœä»½}</td>
                        <td title="${fields.å­¦æ ¡}">${fields.å­¦æ ¡.length > 8 ? fields.å­¦æ ¡.substring(0, 8) + '...' : fields.å­¦æ ¡}</td>
                        <td>${fields.ç§‘ç±»}</td>
                        <td>${fields.æ‰¹æ¬¡}</td>
                        <td>${fields.ä¸“ä¸šç»„ä»£ç  || '-'}</td>
                        <td title="${result.otherInfo.ä¸“ä¸š}">${result.otherInfo.ä¸“ä¸š.length > 10 ? result.otherInfo.ä¸“ä¸š.substring(0, 10) + '...' : result.otherInfo.ä¸“ä¸š}</td>
                        <td>
                            <span class="${result.exists ? 'status-exists' : 'status-not-exists'}">
                                ${result.exists ? 'âœ“ å­˜åœ¨' : 'âœ— ä¸å­˜åœ¨'}
                            </span>
                        </td>
                    </tr>
                `;
            }
            
            html += `</tbody></table>`;
            
            if ((planCollegeFilterState.displayOption === '100' && filteredResults.length > 100) || 
                (planCollegeFilterState.displayOption === '500' && filteredResults.length > 500)) {
                const limit = planCollegeFilterState.displayOption === '100' ? 100 : 500;
                html += `<p style="text-align:center; margin-top:10px; color:#7f8c8d;">
                    ä»…æ˜¾ç¤ºå‰${limit}æ¡è®°å½•ï¼Œå…±${filteredResults.length}æ¡è®°å½•ã€‚å¯¼å‡ºExcelæŸ¥çœ‹å…¨éƒ¨ç»“æœï¼Œæˆ–é€‰æ‹©"æ˜¾ç¤ºå…¨éƒ¨è®°å½•"æŸ¥çœ‹æ‰€æœ‰æ•°æ®ã€‚
                </p>`;
            } else if (filteredResults.length > 500) {
                html += `<p style="text-align:center; margin-top:10px; color:#7f8c8d;">
                    å½“å‰æ˜¾ç¤º${filteredResults.length}æ¡è®°å½•ã€‚æ•°æ®é‡è¾ƒå¤§ï¼Œå»ºè®®ä½¿ç”¨ç­›é€‰åŠŸèƒ½æŸ¥çœ‹ç‰¹å®šæ•°æ®ã€‚
                </p>`;
            }
            
            tableContainer.innerHTML = html;
        }
        
        function checkExportAllButton() {
            const exportAllBtn = document.getElementById('exportAllBtn');
            if (planScoreResults.length > 0 || planCollegeResults.length > 0) {
                exportAllBtn.style.display = 'inline-block';
            } else {
                exportAllBtn.style.display = 'none';
            }
        }
        
        function exportPlanScoreResults() {
            if (planScoreResults.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }
            
            try {
                const exportData = planScoreResults.map(result => ({
                    'åºå·': result.index,
                    'å¹´ä»½': result.keyFields.å¹´ä»½,
                    'çœä»½': result.keyFields.çœä»½,
                    'å­¦æ ¡': result.keyFields.å­¦æ ¡,
                    'ç§‘ç±»': result.keyFields.ç§‘ç±»,
                    'æ‰¹æ¬¡': result.keyFields.æ‰¹æ¬¡,
                    'ä¸“ä¸š': result.keyFields.ä¸“ä¸š,
                    'å±‚æ¬¡': result.keyFields.å±‚æ¬¡,
                    'ä¸“ä¸šç»„ä»£ç ': result.keyFields.ä¸“ä¸šç»„ä»£ç ,
                    'æ‹›ç”Ÿäººæ•°': result.otherInfo.æ‹›ç”Ÿäººæ•°,
                    'å­¦è´¹': result.otherInfo.å­¦è´¹,
                    'å­¦åˆ¶': result.otherInfo.å­¦åˆ¶,
                    'ä¸“ä¸šä»£ç ': result.otherInfo.ä¸“ä¸šä»£ç ,
                    'åŒ¹é…çŠ¶æ€': result.exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                    'åŒ¹é…è¯´æ˜': result.exists ? 
                        'è¯¥è®°å½•åœ¨ä¸“ä¸šåˆ†æ–‡ä»¶ä¸­å­˜åœ¨' : 
                        'è¯¥è®°å½•åœ¨ä¸“ä¸šåˆ†æ–‡ä»¶ä¸­ä¸å­˜åœ¨'
                }));
                
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'æ¯”å¯¹1_æ‹›ç”Ÿè®¡åˆ’vsä¸“ä¸šåˆ†');
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                const filename = `æ¯”å¯¹1_æ‹›ç”Ÿè®¡åˆ’vsä¸“ä¸šåˆ†_${timestamp}.xlsx`;
                
                XLSX.writeFile(workbook, filename);
                
                alert(`æ¯”å¯¹1ç»“æœå·²å¯¼å‡ºä¸º ${filename}`);
                
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
                console.error('å¯¼å‡ºé”™è¯¯:', error);
            }
        }
        
        function exportPlanCollegeResults() {
            if (planCollegeResults.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }
            
            try {
                const exportData = planCollegeResults.map(result => {
                    return {
                        'åºå·': result.index,
                        'å¹´ä»½': result.keyFields.å¹´ä»½,
                        'çœä»½': result.keyFields.çœä»½,
                        'å­¦æ ¡': result.keyFields.å­¦æ ¡,
                        'ç§‘ç±»': result.keyFields.ç§‘ç±»,
                        'æ‰¹æ¬¡': result.keyFields.æ‰¹æ¬¡,
                        'ä¸“ä¸šç»„ä»£ç ': result.keyFields.ä¸“ä¸šç»„ä»£ç ,
                        'ä¸“ä¸š': result.otherInfo.ä¸“ä¸š,
                        'å±‚æ¬¡': result.otherInfo.å±‚æ¬¡,
                        'æ‹›ç”Ÿäººæ•°': result.otherInfo.æ‹›ç”Ÿäººæ•°,
                        'åŒ¹é…çŠ¶æ€': result.exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                        'åŒ¹é…è¯´æ˜': result.exists ? 
                            'è¯¥è®°å½•åœ¨é™¢æ ¡åˆ†æ–‡ä»¶ä¸­å­˜åœ¨' : 
                            'è¯¥è®°å½•åœ¨é™¢æ ¡åˆ†æ–‡ä»¶ä¸­ä¸å­˜åœ¨'
                    };
                });
                
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'æ¯”å¯¹2_æ‹›ç”Ÿè®¡åˆ’vsé™¢æ ¡åˆ†');
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                const filename = `æ¯”å¯¹2_æ‹›ç”Ÿè®¡åˆ’vsé™¢æ ¡åˆ†_${timestamp}.xlsx`;
                
                XLSX.writeFile(workbook, filename);
                
                alert(`æ¯”å¯¹2ç»“æœå·²å¯¼å‡ºä¸º ${filename}`);
                
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
                console.error('å¯¼å‡ºé”™è¯¯:', error);
            }
        }
        
        function exportAllResults() {
            if (planScoreResults.length === 0 && planCollegeResults.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }
            
            try {
                const workbook = XLSX.utils.book_new();
                
                if (planScoreResults.length > 0) {
                    const planScoreExportData = planScoreResults.map(result => ({
                        'åºå·': result.index,
                        'å¹´ä»½': result.keyFields.å¹´ä»½,
                        'çœä»½': result.keyFields.çœä»½,
                        'å­¦æ ¡': result.keyFields.å­¦æ ¡,
                        'ç§‘ç±»': result.keyFields.ç§‘ç±»,
                        'æ‰¹æ¬¡': result.keyFields.æ‰¹æ¬¡,
                        'ä¸“ä¸š': result.keyFields.ä¸“ä¸š,
                        'å±‚æ¬¡': result.keyFields.å±‚æ¬¡,
                        'ä¸“ä¸šç»„ä»£ç ': result.keyFields.ä¸“ä¸šç»„ä»£ç ,
                        'æ‹›ç”Ÿäººæ•°': result.otherInfo.æ‹›ç”Ÿäººæ•°,
                        'å­¦è´¹': result.otherInfo.å­¦è´¹,
                        'å­¦åˆ¶': result.otherInfo.å­¦åˆ¶,
                        'ä¸“ä¸šä»£ç ': result.otherInfo.ä¸“ä¸šä»£ç ,
                        'åŒ¹é…çŠ¶æ€': result.exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                        'åŒ¹é…è¯´æ˜': result.exists ? 
                            'è¯¥è®°å½•åœ¨ä¸“ä¸šåˆ†æ–‡ä»¶ä¸­å­˜åœ¨' : 
                            'è¯¥è®°å½•åœ¨ä¸“ä¸šåˆ†æ–‡ä»¶ä¸­ä¸å­˜åœ¨'
                    }));
                    
                    const planScoreWorksheet = XLSX.utils.json_to_sheet(planScoreExportData);
                    XLSX.utils.book_append_sheet(workbook, planScoreWorksheet, 'æ¯”å¯¹1_æ‹›ç”Ÿè®¡åˆ’vsä¸“ä¸šåˆ†');
                }
                
                if (planCollegeResults.length > 0) {
                    const planCollegeExportData = planCollegeResults.map(result => {
                        return {
                            'åºå·': result.index,
                            'å¹´ä»½': result.keyFields.å¹´ä»½,
                            'çœä»½': result.keyFields.çœä»½,
                            'å­¦æ ¡': result.keyFields.å­¦æ ¡,
                            'ç§‘ç±»': result.keyFields.ç§‘ç±»,
                            'æ‰¹æ¬¡': result.keyFields.æ‰¹æ¬¡,
                            'ä¸“ä¸šç»„ä»£ç ': result.keyFields.ä¸“ä¸šç»„ä»£ç ,
                            'ä¸“ä¸š': result.otherInfo.ä¸“ä¸š,
                            'å±‚æ¬¡': result.otherInfo.å±‚æ¬¡,
                            'æ‹›ç”Ÿäººæ•°': result.otherInfo.æ‹›ç”Ÿäººæ•°,
                            'åŒ¹é…çŠ¶æ€': result.exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                            'åŒ¹é…è¯´æ˜': result.exists ? 
                                'è¯¥è®°å½•åœ¨é™¢æ ¡åˆ†æ–‡ä»¶ä¸­å­˜åœ¨' : 
                                'è¯¥è®°å½•åœ¨é™¢æ ¡åˆ†æ–‡ä»¶ä¸­ä¸å­˜åœ¨'
                        };
                    });
                    
                    const planCollegeWorksheet = XLSX.utils.json_to_sheet(planCollegeExportData);
                    XLSX.utils.book_append_sheet(workbook, planCollegeWorksheet, 'æ¯”å¯¹2_æ‹›ç”Ÿè®¡åˆ’vsé™¢æ ¡åˆ†');
                }
                
                const summaryData = [
                    ['æ•°æ®æ¯”å¯¹å·¥å…·ç»Ÿè®¡æŠ¥å‘Š', '', '', ''],
                    ['ç”Ÿæˆæ—¶é—´', new Date().toLocaleString(), '', ''],
                    ['', '', '', ''],
                    ['æ¯”å¯¹ç±»å‹', 'æ€»è®°å½•æ•°', 'åŒ¹é…è®°å½•æ•°', 'åŒ¹é…ç‡'],
                    ['æ¯”å¯¹1ï¼šæ‹›ç”Ÿè®¡åˆ’ vs ä¸“ä¸šåˆ†', 
                     planScoreResults.length, 
                     planScoreResults.filter(r => r.exists).length, 
                     planScoreResults.length > 0 ? ((planScoreResults.filter(r => r.exists).length / planScoreResults.length * 100).toFixed(1) + '%') : '0%'],
                    ['æ¯”å¯¹2ï¼šæ‹›ç”Ÿè®¡åˆ’ vs é™¢æ ¡åˆ†', 
                     planCollegeResults.length, 
                     planCollegeResults.filter(r => r.exists).length, 
                     planCollegeResults.length > 0 ? ((planCollegeResults.filter(r => r.exists).length / planCollegeResults.length * 100).toFixed(1) + '%') : '0%']
                ];
                
                const summaryWorksheet = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(workbook, summaryWorksheet, 'ç»Ÿè®¡æŠ¥å‘Š');
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                const filename = `æ•°æ®æ¯”å¯¹ç»“æœæ±‡æ€»_${timestamp}.xlsx`;
                
                XLSX.writeFile(workbook, filename);
                
                alert(`å…¨éƒ¨ç»“æœå·²å¯¼å‡ºä¸º ${filename}\nåŒ…å«${workbook.SheetNames.length}ä¸ªå·¥ä½œè¡¨`);
                
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
                console.error('å¯¼å‡ºé”™è¯¯:', error);
            }
        }
        
        function resetAll() {
            isComparing = false;
            
            planData = [];
            scoreData = [];
            collegeData = [];
            
            document.getElementById('planFile').value = '';
            document.getElementById('scoreFile').value = '';
            document.getElementById('collegeFile').value = '';
            
            document.getElementById('planInfo').textContent = 'ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...';
            document.getElementById('scoreInfo').textContent = 'ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...';
            document.getElementById('collegeInfo').textContent = 'ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...';
            
            resetComparisonResults();
            
            document.getElementById('resultSection').style.display = 'none';
            
            switchTab('planScoreTab');
            
            checkAllFilesLoaded();
            
            alert('é‡ç½®å®Œæˆï¼æ‰€æœ‰æ•°æ®å’ŒçŠ¶æ€å·²æ¸…é™¤ã€‚');
        }
        
        function switchTab(tabId) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
        }
        
        function showResultSection() {
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function startLoading(text) {
            if (text) {
                document.getElementById('loadingText').textContent = text;
            }
            document.getElementById('loading').style.display = 'block';
        }
        
        function stopLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        console.log('æ‹›ç”Ÿè®¡åˆ’æ•°æ®æ¯”å¯¹ä¸è½¬æ¢å·¥å…·å·²åŠ è½½');
    </script>
</body>
</html>
